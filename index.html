<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Treasure Hunter Â· æ‘¸é‡‘èƒŒå•è¯</title>
  <style>
    :root {
      --cave-bg: linear-gradient(135deg, #2d1b0a 0%, #1a0d05 100%);
      --treasure-gold: #ffd700;
      --treasure-bronze: #cd7f32;
      --treasure-silver: #c0c0c0;
      --treasure-diamond: #b9f2ff;
      --ancient-stone: #4a4a4a;
      --parchment: #f4e4bc;
      --shadow-dark: rgba(0,0,0,0.8);
      --glow-gold: 0 0 20px rgba(255,215,0,0.5);
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--cave-bg);
      font-family: 'Georgia', 'Times New Roman', serif;
      color: var(--parchment);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(255,215,0,0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255,215,0,0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255,255,255,0.02) 0%, transparent 50%);
    }
    
    #game-container {
      width: min(95vw, 600px);
      background: linear-gradient(145deg, #3d2914, #2a1a0a);
      border-radius: 20px;
      border: 3px solid var(--treasure-gold);
      box-shadow: 
        var(--glow-gold),
        inset 0 2px 10px rgba(255,215,0,0.1),
        0 20px 40px var(--shadow-dark);
      position: relative;
      overflow: hidden;
    }
    
    #game-container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--treasure-gold), var(--treasure-bronze), var(--treasure-gold));
      z-index: -1;
      border-radius: 20px;
    }
    
    .header {
      background: linear-gradient(90deg, var(--treasure-gold), #ffed4a, var(--treasure-gold));
      color: #2d1b0a;
      padding: 15px 25px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      border-bottom: 2px solid var(--treasure-bronze);
    }
    
    .stats-bar {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      padding: 20px 25px;
      background: linear-gradient(180deg, #4a3219, #3d2914);
      border-bottom: 1px solid var(--treasure-bronze);
    }
    
    .stat-item {
      text-align: center;
      padding: 10px;
      background: linear-gradient(145deg, #5a4028, #4a3219);
      border-radius: 15px;
      border: 2px solid var(--treasure-bronze);
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .stat-icon {
      font-size: 24px;
      margin-bottom: 5px;
      display: block;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--treasure-gold);
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
    }
    
    .treasure-chamber {
      padding: 30px 25px;
      text-align: center;
      background: radial-gradient(circle at center, #4a3219, #3d2914);
      position: relative;
    }
    
    .treasure-chest {
      width: 120px;
      height: 120px;
      background: linear-gradient(145deg, #8b4513, #a0522d);
      border: 4px solid var(--treasure-gold);
      border-radius: 15px 15px 25px 25px;
      margin: 0 auto 20px;
      position: relative;
      box-shadow: var(--glow-gold);
      animation: treasureGlow 3s infinite alternate;
    }
    
    @keyframes treasureGlow {
      0% { box-shadow: var(--glow-gold); }
      100% { box-shadow: 0 0 30px rgba(255,215,0,0.8); }
    }
    
    .treasure-chest::before {
      content: 'ğŸ’';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 40px;
      animation: sparkle 2s infinite;
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); }
      50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
    }
    
    .treasure-info {
      background: rgba(116, 88, 48, 0.6);
      border: 2px solid var(--treasure-gold);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      backdrop-filter: blur(5px);
    }
    
    .treasure-name {
      font-size: 36px;
      font-weight: bold;
      color: var(--treasure-gold);
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .treasure-phonetic {
      font-size: 18px;
      color: var(--treasure-silver);
      margin-bottom: 15px;
      font-style: italic;
    }
    
    .treasure-description {
      font-size: 16px;
      line-height: 1.5;
      opacity: 0.9;
    }
    
    .treasure-value {
      display: inline-block;
      background: linear-gradient(45deg, var(--treasure-gold), #ffed4a);
      color: #2d1b0a;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      margin-top: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .action-buttons {
      display: grid;
      gap: 15px;
      padding: 25px;
      background: linear-gradient(180deg, #3d2914, #2d1b0a);
    }
    
    .treasure-btn {
      padding: 15px;
      border: none;
      border-radius: 15px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      font-family: inherit;
    }
    
    .speak-btn {
      background: linear-gradient(145deg, var(--treasure-gold), #ffed4a);
      color: #2d1b0a;
      border: 3px solid var(--treasure-bronze);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    .speak-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
    }
    
    .speak-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .manual-input {
      display: flex;
      gap: 10px;
    }
    
    .manual-input input {
      flex: 1;
      padding: 15px;
      border: 2px solid var(--treasure-bronze);
      border-radius: 12px;
      background: rgba(74, 57, 25, 0.8);
      color: var(--parchment);
      font-size: 16px;
      font-family: inherit;
    }
    
    .manual-input input:focus {
      outline: none;
      border-color: var(--treasure-gold);
      box-shadow: 0 0 10px rgba(255,215,0,0.3);
    }
    
    .submit-btn {
      background: linear-gradient(145deg, var(--treasure-silver), #e8e8e8);
      color: #2d1b0a;
      border: 2px solid var(--ancient-stone);
      padding: 15px 25px;
      border-radius: 12px;
    }
    
    .submit-btn:hover {
      background: linear-gradient(145deg, #e8e8e8, var(--treasure-silver));
      transform: translateY(-1px);
    }
    
    .feedback {
      padding: 20px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-top: 1px solid var(--treasure-bronze);
      background: rgba(45, 27, 10, 0.5);
    }
    
    .feedback.success {
      color: var(--treasure-gold);
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
      animation: successPulse 0.6s ease-out;
    }
    
    .feedback.error {
      color: #ff6b6b;
      text-shadow: 0 0 10px rgba(255,107,107,0.5);
    }
    
    @keyframes successPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(30px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideInRight {
      0% {
        opacity: 0;
        transform: translateX(30px);
      }
      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes coinSpin {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(360deg); }
    }
    
    @keyframes celebrate {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.1) rotate(-5deg); }
      75% { transform: scale(1.1) rotate(5deg); }
    }
    
    @keyframes modalSlideIn {
      0% {
        opacity: 0;
        transform: scale(0.7) translateY(-50px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    /* é¡µé¢åŠ è½½åŠ¨ç”» */
    #game-container {
      animation: fadeInUp 0.8s ease-out;
    }
    
    .stats-bar {
      animation: slideInRight 0.6s ease-out 0.2s both;
    }
    
    .treasure-chamber {
      animation: fadeInUp 0.6s ease-out 0.4s both;
    }
    
    .action-buttons {
      animation: fadeInUp 0.6s ease-out 0.6s both;
    }
    
    /* è·å¾—é‡‘å¸åŠ¨ç”» */
    .coin-earned {
      animation: coinSpin 0.5s ease-out;
    }
    
    /* åº†ç¥åŠ¨ç”» */
    .celebrate {
      animation: celebrate 0.6s ease-out;
    }
    
    /* å•†åº—æ¨¡æ€åŠ¨ç”» */
    .shop-content {
      animation: modalSlideIn 0.3s ease-out;
    }
    
    .shop-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(145deg, var(--treasure-gold), #ffed4a);
      border: 3px solid var(--treasure-bronze);
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--glow-gold);
      z-index: 1000;
      transition: transform 0.3s ease;
      animation: float 3s ease-in-out infinite;
    }
    
    .shop-btn:hover {
      transform: scale(1.1);
    }
    
    /* Unit Selector Styles */
    .unit-selector {
      background: linear-gradient(135deg, #4a3219, #3d2914);
      border-bottom: 2px solid var(--treasure-bronze);
      padding: 15px 20px;
    }
    
    .unit-title {
      color: var(--treasure-gold);
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .unit-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .unit-grid.expanded {
      max-height: 400px;
    }
    
    .unit-card {
      background: linear-gradient(145deg, rgba(116, 88, 48, 0.6), rgba(74, 57, 25, 0.8));
      border: 2px solid var(--treasure-bronze);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .unit-card:hover {
      border-color: var(--treasure-gold);
      background: linear-gradient(145deg, rgba(116, 88, 48, 0.8), rgba(74, 57, 25, 1));
      transform: translateY(-2px);
    }
    
    .unit-card.active {
      border-color: var(--treasure-gold);
      background: linear-gradient(145deg, var(--treasure-gold), #ffed4a);
      color: #2d1b0a;
      box-shadow: var(--glow-gold);
    }
    
    .unit-card.completed {
      background: linear-gradient(145deg, var(--treasure-silver), #e8e8e8);
      border-color: var(--treasure-silver);
    }
    
    .unit-icon {
      font-size: 20px;
      margin-bottom: 5px;
      display: block;
    }
    
    .unit-name {
      font-size: 12px;
      font-weight: bold;
      line-height: 1.2;
    }
    
    .unit-progress {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--treasure-gold);
      color: #2d1b0a;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }
    
    .unit-toggle {
      background: linear-gradient(145deg, var(--treasure-bronze), #8b4513);
      border: none;
      color: var(--parchment);
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 0 auto;
      display: block;
      transition: all 0.3s ease;
    }
    
    .unit-toggle:hover {
      background: linear-gradient(145deg, var(--treasure-gold), #ffed4a);
      color: #2d1b0a;
    }
    
    .current-unit-display {
      background: rgba(116, 88, 48, 0.4);
      border: 1px solid var(--treasure-bronze);
      border-radius: 8px;
      padding: 8px 12px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .reset-unit-btn {
      background: linear-gradient(145deg, #ff6b6b, #ff8e53);
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      margin-left: auto;
    }
    
    .reset-unit-btn:hover {
      background: linear-gradient(145deg, #ff8e53, #ff6b6b);
    }
    
    .pronunciation-btn {
      background: linear-gradient(145deg, #9c88ff, #6c5ce7);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .pronunciation-btn:hover {
      background: linear-gradient(145deg, #6c5ce7, #9c88ff);
      transform: translateY(-1px);
    }
    
    .pronunciation-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    @media (max-width: 480px) {
      .unit-grid {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 8px;
      }
      
      .unit-card {
        padding: 8px;
      }
      
      .unit-icon {
        font-size: 16px;
      }
      
      .unit-name {
        font-size: 11px;
      }
    }
    
    #compat-msg {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      border: 2px solid #ff4757;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
    }
    
    /* Shop Modal */
    .shop-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .shop-content {
      background: linear-gradient(145deg, #3d2914, #2a1a0a);
      border: 3px solid var(--treasure-gold);
      border-radius: 20px;
      width: min(90vw, 500px);
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--glow-gold);
    }

    .shop-header {
      background: linear-gradient(90deg, var(--treasure-gold), #ffed4a, var(--treasure-gold));
      color: #2d1b0a;
      padding: 15px 25px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      border-radius: 17px 17px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .shop-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #2d1b0a;
      padding: 0;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .shop-items {
      padding: 20px;
    }

    .shop-item {
      background: rgba(116, 88, 48, 0.3);
      border: 2px solid var(--treasure-bronze);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s ease;
    }

    .shop-item:hover {
      background: rgba(116, 88, 48, 0.5);
      border-color: var(--treasure-gold);
    }

    .shop-item-icon {
      font-size: 30px;
      width: 50px;
      text-align: center;
    }

    .shop-item-info {
      flex: 1;
    }

    .shop-item-name {
      font-size: 16px;
      font-weight: bold;
      color: var(--treasure-gold);
      margin-bottom: 5px;
    }

    .shop-item-desc {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .shop-item-price {
      font-size: 14px;
      color: var(--treasure-gold);
      font-weight: bold;
    }

    .shop-buy-btn {
      background: linear-gradient(145deg, var(--treasure-gold), #ffed4a);
      color: #2d1b0a;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .shop-buy-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .shop-buy-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .inventory-info {
      background: rgba(74, 57, 25, 0.6);
      border: 1px solid var(--treasure-bronze);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .inventory-title {
      color: var(--treasure-gold);
      font-weight: bold;
      margin-bottom: 10px;
    }

    .owned-items {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .owned-item {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid var(--treasure-gold);
      border-radius: 8px;
      padding: 5px 10px;
      font-size: 12px;
    }

    @media (max-width: 480px) {
      .stats-bar {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        padding: 15px 20px;
      }
      .treasure-name { font-size: 28px; }
      .action-buttons { padding: 20px; }
      
      .shop-content {
        width: 95vw;
        margin: 10px;
      }
      
      .shop-item {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div id="compat-msg"></div>
  
  <div id="game-container">
    <div class="header">ğŸº æ‘¸é‡‘èƒŒå•è¯å¤§å¸ˆ ğŸº</div>
    
    <!-- Unit Selector -->
    <div class="unit-selector">
      <div class="unit-title">ğŸ“š é€‰æ‹©å­¦ä¹ å•å…ƒ</div>
      <div class="current-unit-display" id="current-unit-display">
        <span id="current-unit-info">ğŸ¯ å½“å‰ï¼šå…¨éƒ¨å•å…ƒæ··åˆæ¨¡å¼</span>
        <button class="reset-unit-btn" id="reset-unit-btn">é‡ç½®</button>
      </div>
      <button class="unit-toggle" id="unit-toggle">å±•å¼€å•å…ƒé€‰æ‹©</button>
      <div class="unit-grid" id="unit-grid"></div>
    </div>
    
    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-icon">ğŸ’°</span>
        <div class="stat-label">é‡‘å¸</div>
        <div class="stat-value" id="coins">500</div>
      </div>
      <div class="stat-item">
        <span class="stat-icon">âš¡</span>
        <div class="stat-label">ç­‰çº§</div>
        <div class="stat-value" id="level">1</div>
      </div>
      <div class="stat-item">
        <span class="stat-icon">ğŸ’</span>
        <div class="stat-label">å®ç‰©</div>
        <div class="stat-value" id="treasures">0</div>
      </div>
    </div>
    
    <div class="treasure-chamber">
      <div class="treasure-chest" id="treasure-chest"></div>
      
      <div class="treasure-info">
        <div class="treasure-name" id="treasure-name">Ancient Relic</div>
        <div class="treasure-phonetic" id="treasure-phonetic">/ËˆeÉªnÊƒÉ™nt ËˆrÉ›lÉªk/</div>
        <div class="treasure-description" id="treasure-description">
          A mysterious artifact from ancient civilizations, waiting to be claimed by brave treasure hunters.
        </div>
        <div class="treasure-value" id="treasure-value">ä»·å€¼: 50é‡‘å¸</div>
        <button class="pronunciation-btn" id="pronunciation-btn">ğŸ”Š å¬å‘éŸ³</button>
      </div>
    </div>
    
    <div class="action-buttons">
      <button class="treasure-btn speak-btn" id="speak-btn">
        ğŸ™ï¸ è¯´å‡ºå®ç‰©çœŸåï¼Œè·å¾—å®è—
      </button>
      
      <div class="manual-input">
        <input type="text" id="manual-input" placeholder="æˆ–è€…åœ¨æ­¤è¾“å…¥å®ç‰©çš„è‹±æ–‡åç§°...">
        <button class="treasure-btn submit-btn" id="submit-btn">ğŸ” é‰´å®š</button>
      </div>
    </div>
    
    <div class="feedback" id="feedback">
      å‡†å¤‡å¥½äº†å—ï¼Ÿè¯´å‡ºå®ç‰©çš„è‹±æ–‡åç§°æ¥è·å¾—å®ƒå§ï¼
    </div>
  </div>
  
  <button class="shop-btn" id="shop-btn" title="å®ç‰©å•†åº—">ğŸª</button>

  <!-- Shop Modal -->
  <div class="shop-modal" id="shop-modal">
    <div class="shop-content">
      <div class="shop-header">
        <span>ğŸª ç¥ç§˜å®ç‰©å•†åº—</span>
        <button class="shop-close" id="shop-close">Ã—</button>
      </div>
      <div class="shop-items">
        <div class="inventory-info">
          <div class="inventory-title">ğŸ’° å½“å‰é‡‘å¸: <span id="shop-coins">500</span></div>
          <div class="inventory-title">ğŸ’ å·²æ‹¥æœ‰é“å…·:</div>
          <div class="owned-items" id="owned-items">
            <span class="owned-item">æš‚æ— é“å…·</span>
          </div>
        </div>
        <div id="shop-items-container"></div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- DOM Elements ---
      const ui = {
        coins: document.getElementById('coins'),
        level: document.getElementById('level'),
        treasures: document.getElementById('treasures'),
        treasureChest: document.getElementById('treasure-chest'),
        treasureName: document.getElementById('treasure-name'),
        treasurePhonetic: document.getElementById('treasure-phonetic'),
        treasureDescription: document.getElementById('treasure-description'),
        treasureValue: document.getElementById('treasure-value'),
        feedback: document.getElementById('feedback'),
        speakBtn: document.getElementById('speak-btn'),
        manualInput: document.getElementById('manual-input'),
        submitBtn: document.getElementById('submit-btn'),
        shopBtn: document.getElementById('shop-btn'),
        compatMsg: document.getElementById('compat-msg'),
        shopModal: document.getElementById('shop-modal'),
        shopClose: document.getElementById('shop-close'),
        shopCoins: document.getElementById('shop-coins'),
        ownedItems: document.getElementById('owned-items'),
        shopItemsContainer: document.getElementById('shop-items-container'),
        // Unit selector elements
        unitToggle: document.getElementById('unit-toggle'),
        unitGrid: document.getElementById('unit-grid'),
        currentUnitInfo: document.getElementById('current-unit-info'),
        resetUnitBtn: document.getElementById('reset-unit-btn'),
        pronunciationBtn: document.getElementById('pronunciation-btn'),
      };

      // --- Audio System ---
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      
      function playSound(type, frequency = 440, duration = 200) {
        if (!audioContext) return;
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        switch(type) {
          case 'success':
            // æˆåŠŸéŸ³æ•ˆ - ä¸Šå‡éŸ³è°ƒ
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + duration / 1000);
            oscillator.type = 'sine';
            break;
          case 'error':
            // é”™è¯¯éŸ³æ•ˆ - ä¸‹é™éŸ³è°ƒ
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + duration / 1000);
            oscillator.type = 'sawtooth';
            break;
          case 'coin':
            // é‡‘å¸éŸ³æ•ˆ - æ¸…è„†éŸ³è°ƒ
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
            oscillator.type = 'square';
            duration = 150;
            break;
          case 'click':
            // ç‚¹å‡»éŸ³æ•ˆ - çŸ­ä¿ƒéŸ³è°ƒ
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
            oscillator.type = 'triangle';
            duration = 100;
            break;
          case 'level':
            // å‡çº§éŸ³æ•ˆ - ä¸‰é‡éŸ³è°ƒ
            playLevelUpSound();
            return;
        }
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration / 1000);
      }
      
      function playLevelUpSound() {
        // å‡çº§éŸ³æ•ˆ - ä¸‰ä¸ªéŸ³ç¬¦ç»„æˆçš„æ—‹å¾‹
        const notes = [523, 659, 784]; // C5, E5, G5
        notes.forEach((freq, i) => {
          setTimeout(() => playSound('success', freq, 300), i * 200);
        });
      }

      // --- Game State ---
      const state = {
        coins: 500,
        level: 1,
        treasuresFound: 0,
        recognizing: false,
        currentTreasureIndex: 0,
        inventory: [],
        ownedItems: [],
        activeEffects: {
          goldMultiplier: 1,
          hintAvailable: false,
          expBoost: 1
        },
        // Unit system
        selectedUnit: null, // null = all units mixed
        unitProgress: {}, // track progress for each unit
        unitGridExpanded: false
      };

      // --- Shop Items ---
      const SHOP_ITEMS = [
        {
          id: 'gold_potion',
          name: 'ğŸ’ é»„é‡‘è¯æ°´',
          desc: 'æ¥ä¸‹æ¥5ä¸ªå®è—çš„é‡‘å¸å¥–åŠ±ç¿»å€',
          price: 300,
          icon: 'ğŸ’',
          effect: 'gold_boost',
          uses: 5
        },
        {
          id: 'hint_crystal',
          name: 'ğŸ”® æç¤ºæ°´æ™¶',
          desc: 'å¯ä»¥æŸ¥çœ‹å½“å‰å®ç‰©çš„é¦–å­—æ¯æç¤º',
          price: 150,
          icon: 'ğŸ”®',
          effect: 'hint',
          uses: 3
        },
        {
          id: 'exp_amulet',
          name: 'âš¡ ç»éªŒæŠ¤ç¬¦',
          desc: 'å‡çº§æ‰€éœ€å®ç‰©æ•°é‡å‡å°‘1ä¸ªï¼ˆæ°¸ä¹…ï¼‰',
          price: 500,
          icon: 'âš¡',
          effect: 'exp_boost',
          uses: 1,
          permanent: true
        },
        {
          id: 'luck_charm',
          name: 'ğŸ€ å¹¸è¿ç¬¦å’’',
          desc: 'å‘éŸ³é”™è¯¯æ—¶æœ‰50%å‡ ç‡ä¸æ‰£é‡‘å¸',
          price: 200,
          icon: 'ğŸ€',
          effect: 'luck',
          uses: 10
        },
        {
          id: 'voice_enhancer',
          name: 'ğŸ™ï¸ è¯­éŸ³å¢å¼ºå™¨',
          desc: 'æé«˜è¯­éŸ³è¯†åˆ«å‡†ç¡®åº¦ï¼ˆé™ä½è¯†åˆ«é—¨æ§›ï¼‰',
          price: 400,
          icon: 'ğŸ™ï¸',
          effect: 'voice_boost',
          uses: 1,
          permanent: true
        }
      ];

      // --- æŒ‰å•å…ƒç»„ç»‡çš„å•è¯åº“ (äººæ•™ç‰ˆ7å¹´çº§ä¸Šå†Œ) ---
      const UNIT_TREASURES = {
        unit1: {
          name: "Unit 1 - åˆæ¬¡ç›¸é‡",
          icon: "ğŸ‘‹",
          words: [
            { name: 'name', ipa: '/neÉªm/', desc: 'è®°å½•èº«ä»½çš„ç¥ç§˜ç¬¦æ–‡', value: 20, icon: 'ğŸ“›' },
            { name: 'nice', ipa: '/naÉªs/', desc: 'å¸¦æ¥æ„‰æ‚¦çš„æ¸©æš–å®çŸ³', value: 25, icon: 'ğŸ˜Š' },
            { name: 'meet', ipa: '/miËt/', desc: 'è¿æ¥å¿ƒçµçš„æ¡¥æ¢', value: 25, icon: 'ğŸ¤' },
            { name: 'hello', ipa: '/hÉ™ËˆloÊŠ/', desc: 'å¼€å¯å‹è°Šå¤§é—¨çš„é­”æ³•å’’è¯­', value: 20, icon: 'ğŸ‘‹' },
            { name: 'hi', ipa: '/haÉª/', desc: 'ç®€å•å´æ¸©æš–çš„é—®å€™ä¹‹å…‰', value: 15, icon: 'ğŸŒŸ' },
            { name: 'good', ipa: '/É¡ÊŠd/', desc: 'è•´å«å–„è‰¯åŠ›é‡çš„å¤è€è¯æ±‡', value: 25, icon: 'âœ¨' },
            { name: 'morning', ipa: '/ËˆmÉ”ËrnÉªÅ‹/', desc: 'æ›™å…‰åˆç°çš„å¸Œæœ›æ—¶åˆ»', value: 40, icon: 'ğŸŒ…' },
            { name: 'afternoon', ipa: '/ËŒÃ¦ftÉ™rËˆnuËn/', desc: 'é˜³å…‰æ­£ç››çš„æ´»åŠ›æ—¶å…‰', value: 50, icon: 'â˜€ï¸' },
            { name: 'evening', ipa: '/ËˆiËvnÉªÅ‹/', desc: 'å¤•é˜³è¥¿ä¸‹çš„å®é™æ—¶åˆ†', value: 45, icon: 'ğŸŒ†' },
            { name: 'thanks', ipa: '/Î¸Ã¦Å‹ks/', desc: 'æ„Ÿæ©ä¹‹å¿ƒçš„ç¾å¥½å›å“', value: 35, icon: 'ğŸ™' },
            { name: 'fine', ipa: '/faÉªn/', desc: 'å®Œç¾çŠ¶æ€çš„å…‰æ˜å°è®°', value: 25, icon: 'ğŸ‘Œ' },
            { name: 'ok', ipa: '/ËŒoÊŠËˆkeÉª/', desc: 'ç¡®è®¤åŒæ„çš„ç®€æ´ç¬¦å·', value: 15, icon: 'âœ…' }
          ]
        },
        unit2: {
          name: "Unit 2 - å®¶åº­æˆå‘˜",
          icon: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦",
          words: [
            { name: 'family', ipa: '/ËˆfÃ¦mÉ™li/', desc: 'è¡€è„‰ç›¸è¿çš„æ¸©æš–æ¸¯æ¹¾', value: 35, icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦' },
            { name: 'father', ipa: '/ËˆfÉ‘ËÃ°É™r/', desc: 'å¦‚å±±èˆ¬åšå®çš„å®ˆæŠ¤è€…', value: 35, icon: 'ğŸ‘¨' },
            { name: 'mother', ipa: '/ËˆmÊŒÃ°É™r/', desc: 'å¦‚æµ·èˆ¬æ·±æƒ…çš„å‘µæŠ¤è€…', value: 35, icon: 'ğŸ‘©' },
            { name: 'parents', ipa: '/ËˆperÉ™nts/', desc: 'ç”Ÿå‘½èµ·æºçš„åˆ›é€ è€…ä»¬', value: 40, icon: 'ğŸ‘¨â€ğŸ‘©' },
            { name: 'sister', ipa: '/ËˆsÉªstÉ™r/', desc: 'å¿ƒçµç›¸é€šçš„ç«ç‘°èŠ±', value: 35, icon: 'ğŸ‘­' },
            { name: 'brother', ipa: '/ËˆbrÊŒÃ°É™r/', desc: 'å¹¶è‚©ä½œæˆ˜çš„æˆ˜å‹', value: 40, icon: 'ğŸ‘¬' },
            { name: 'grandfather', ipa: '/ËˆÉ¡rÃ¦nfÉ‘ËÃ°É™r/', desc: 'æ™ºæ…§é•¿è€…çš„æ…ˆç¥¥å…‰è¾‰', value: 60, icon: 'ğŸ‘´' },
            { name: 'grandmother', ipa: '/ËˆÉ¡rÃ¦nmÊŒÃ°É™r/', desc: 'æ¸©æš–æ€€æŠ±çš„æ…ˆçˆ±é•¿è¾ˆ', value: 65, icon: 'ğŸ‘µ' },
            { name: 'uncle', ipa: '/ËˆÊŒÅ‹kÉ™l/', desc: 'äº²æƒ…çº½å¸¦çš„å¯é æ”¯æŸ±', value: 30, icon: 'ğŸ‘¨â€ğŸ¦²' },
            { name: 'aunt', ipa: '/Ã¦nt/', desc: 'æ¸©æŸ”å…³æ€€çš„é•¿è¾ˆæ˜ç ', value: 25, icon: 'ğŸ‘©â€ğŸ¦³' },
            { name: 'cousin', ipa: '/ËˆkÊŒzÉ™n/', desc: 'ç«¥å¹´ç©ä¼´çš„äº²æƒ…çº½å¸¦', value: 35, icon: 'ğŸ‘«' },
            { name: 'friend', ipa: '/frend/', desc: 'æ‚£éš¾ä¸å…±çš„çè´µå®è—', value: 35, icon: 'ğŸ‘«' }
          ]
        },
        unit3: {
          name: "Unit 3 - ç¥å¥‡æ•°å­—",
          icon: "ğŸ”¢",
          words: [
            { name: 'zero', ipa: '/ËˆzÉªroÊŠ/', desc: 'ä¸‡ç‰©èµ·æºçš„ç©ºæ— ä¹‹æ•°', value: 25, icon: '0ï¸âƒ£' },
            { name: 'one', ipa: '/wÊŒn/', desc: 'ç‹¬ä¸€æ— äºŒçš„åŠ›é‡æºæ³‰', value: 20, icon: '1ï¸âƒ£' },
            { name: 'two', ipa: '/tuË/', desc: 'å¹³è¡¡å®‡å®™çš„åŒå­åŠ›é‡', value: 20, icon: '2ï¸âƒ£' },
            { name: 'three', ipa: '/Î¸riË/', desc: 'ä¸‰ç”Ÿä¸‡ç‰©çš„ç¥ç§˜æ•°å­—', value: 25, icon: '3ï¸âƒ£' },
            { name: 'four', ipa: '/fÉ”Ër/', desc: 'å››æ–¹å®ˆæŠ¤çš„ç¨³å›ºåŸºçŸ³', value: 25, icon: '4ï¸âƒ£' },
            { name: 'five', ipa: '/faÉªv/', desc: 'äº”è¡Œç›¸ç”Ÿçš„å…ƒç´ ä¹‹åŠ›', value: 25, icon: '5ï¸âƒ£' },
            { name: 'six', ipa: '/sÉªks/', desc: 'å…­åˆä¹‹å†…çš„æ— é™å¯èƒ½', value: 20, icon: '6ï¸âƒ£' },
            { name: 'seven', ipa: '/ËˆsevÉ™n/', desc: 'ä¸ƒæ˜Ÿè¿ç çš„å¹¸è¿æ•°å­—', value: 30, icon: '7ï¸âƒ£' },
            { name: 'eight', ipa: '/eÉªt/', desc: 'å…«å¦å¾ªç¯çš„æ°¸æ’å¯†ç ', value: 30, icon: '8ï¸âƒ£' },
            { name: 'nine', ipa: '/naÉªn/', desc: 'ä¹é‡å¤©å¤–çš„è‡³é«˜åŠ›é‡', value: 25, icon: '9ï¸âƒ£' },
            { name: 'ten', ipa: '/ten/', desc: 'åå…¨åç¾çš„åœ†æ»¡ä¹‹æ•°', value: 20, icon: 'ğŸ”Ÿ' },
            { name: 'phone', ipa: '/foÊŠn/', desc: 'ä¼ é€’åƒé‡ŒéŸ³ä¿¡çš„ç¥å™¨', value: 30, icon: 'ğŸ“' },
            { name: 'number', ipa: '/ËˆnÊŒmbÉ™r/', desc: 'å®‡å®™å¯†ç çš„æ•°å­—å¥¥ç§˜', value: 35, icon: 'ğŸ”¢' },
            { name: 'card', ipa: '/kÉ‘Ërd/', desc: 'è®°å½•é‡è¦ä¿¡æ¯çš„é­”æ³•å¡ç‰‡', value: 25, icon: 'ğŸƒ' }
          ]
        },
        unit4: {
          name: "Unit 4 - ç¼¤çº·è‰²å½©",
          icon: "ğŸ¨",
          words: [
            { name: 'color', ipa: '/ËˆkÊŒlÉ™r/', desc: 'ä¸ºä¸–ç•ŒæŸ“è‰²çš„ç¥å¥‡ç”»ç¬”', value: 30, icon: 'ğŸ¨' },
            { name: 'red', ipa: '/red/', desc: 'å¦‚ç«ç„°èˆ¬ç‚½çƒ­çš„æ¿€æƒ…', value: 20, icon: 'ğŸ”´' },
            { name: 'yellow', ipa: '/ËˆjeloÊŠ/', desc: 'é˜³å…‰èˆ¬æ¸©æš–çš„å…‰èŠ’', value: 35, icon: 'ğŸŸ¡' },
            { name: 'green', ipa: '/É¡riËn/', desc: 'ç”Ÿæœºå‹ƒå‹ƒçš„è‡ªç„¶ä¹‹åŠ›', value: 30, icon: 'ğŸŸ¢' },
            { name: 'blue', ipa: '/bluË/', desc: 'æ·±é‚ƒå¦‚æµ·çš„å®é™ä¹‹æº', value: 25, icon: 'ğŸ”µ' },
            { name: 'black', ipa: '/blÃ¦k/', desc: 'ç¥ç§˜å¤œç©ºçš„æ— å°½æ·±åº¦', value: 30, icon: 'âš«' },
            { name: 'white', ipa: '/waÉªt/', desc: 'çº¯æ´å¦‚é›ªçš„å…‰æ˜ä¹‹å¿ƒ', value: 30, icon: 'âšª' },
            { name: 'purple', ipa: '/ËˆpÉœËrpÉ™l/', desc: 'é«˜è´µå…¸é›…çš„çš‡å®¤è‰²å½©', value: 35, icon: 'ğŸŸ£' },
            { name: 'brown', ipa: '/braÊŠn/', desc: 'å¤§åœ°æ¯äº²çš„æ¸©æš–æ€€æŠ±', value: 30, icon: 'ğŸŸ¤' },
            { name: 'orange', ipa: '/ËˆÉ”ËrÉªndÊ’/', desc: 'ç§‹æ—¥å¤•é˜³çš„æ¸©æŸ”å…‰è¾‰', value: 35, icon: 'ğŸŸ ' },
            { name: 'pink', ipa: '/pÉªÅ‹k/', desc: 'å°‘å¥³å¿ƒä¸­çš„æµªæ¼«æ¢¦æƒ³', value: 25, icon: 'ğŸ©·' },
            { name: 'gray', ipa: '/É¡reÉª/', desc: 'äº‘é›¾ç¼­ç»•çš„ä¸­æ€§ä¹‹ç¾', value: 25, icon: 'ğŸ©¶' }
          ]
        },
        unit5: {
          name: "Unit 5 - æ±‚å­¦ä¹‹è·¯",
          icon: "ğŸ“",
          words: [
            { name: 'school', ipa: '/skuËl/', desc: 'æ™ºæ…§ä¼ æ‰¿çš„ç¥åœ£æ®¿å ‚', value: 60, icon: 'ğŸ«' },
            { name: 'teacher', ipa: '/ËˆtiËtÊƒÉ™r/', desc: 'ç‚¹äº®å¿ƒçµçš„çŸ¥è¯†æ˜ç¯', value: 70, icon: 'ğŸ‘¨â€ğŸ«' },
            { name: 'student', ipa: '/ËˆstuËdÉ™nt/', desc: 'æ¸´æœ›çŸ¥è¯†çš„æ±‚ç´¢è€…', value: 75, icon: 'ğŸ‘¨â€ğŸ“' },
            { name: 'classroom', ipa: '/ËˆklÃ¦sruËm/', desc: 'çŸ¥è¯†èŠ±å›­çš„åŸ¹è‚²æ¸©å®¤', value: 85, icon: 'ğŸ›ï¸' },
            { name: 'subject', ipa: '/ËˆsÊŒbdÊ’Éªkt/', desc: 'å­¦é—®æµ·æ´‹çš„ä¸€å¶æ‰èˆŸ', value: 75, icon: 'ğŸ“š' },
            { name: 'lesson', ipa: '/ËˆlesÉ™n/', desc: 'æ™ºæ…§ä¼ æˆçš„çè´µæ—¶å…‰', value: 35, icon: 'ğŸ“–' },
            { name: 'chinese', ipa: '/ËŒtÊƒaÉªËˆniËz/', desc: 'äº”åƒå¹´æ–‡æ˜çš„è¯­è¨€ç‘°å®', value: 80, icon: 'ğŸ€„' },
            { name: 'english', ipa: '/ËˆÉªÅ‹É¡lÉªÊƒ/', desc: 'è¿æ¥ä¸–ç•Œçš„è¯­è¨€æ¡¥æ¢', value: 80, icon: 'ğŸ‡¬ğŸ‡§' },
            { name: 'math', ipa: '/mÃ¦Î¸/', desc: 'é€»è¾‘æ€ç»´çš„æ•°å­—ç‹å›½', value: 25, icon: 'ğŸ”¢' },
            { name: 'history', ipa: '/ËˆhÉªstÉ™ri/', desc: 'æ—¶é—´é•¿æ²³çš„è®°å¿†å®åº“', value: 85, icon: 'ğŸ“œ' },
            { name: 'geography', ipa: '/dÊ’iËˆÉ‘ËÉ¡rÉ™fi/', desc: 'æ¢ç´¢å¤§åœ°å¥¥ç§˜çš„æŒ‡å—é’ˆ', value: 95, icon: 'ğŸ—ºï¸' },
            { name: 'science', ipa: '/ËˆsaÉªÉ™ns/', desc: 'è§£å¼€å®‡å®™å¯†ç çš„é’¥åŒ™', value: 85, icon: 'ğŸ”¬' }
          ]
        },
        unit6: {
          name: "Unit 6 - æ—¶å…‰å°è®°",
          icon: "ğŸ—“ï¸",
          words: [
            { name: 'birthday', ipa: '/ËˆbÉœËrÎ¸deÉª/', desc: 'ç”Ÿå‘½è¯ç”Ÿçš„çºªå¿µåœ£æ—¥', value: 85, icon: 'ğŸ‚' },
            { name: 'january', ipa: '/ËˆdÊ’Ã¦njueri/', desc: 'æ–°å¹´ä¼Šå§‹çš„å¸Œæœ›ä¹‹æœˆ', value: 90, icon: 'ğŸ“…' },
            { name: 'february', ipa: '/Ëˆfebrueri/', desc: 'çˆ±æ„ç»µç»µçš„æµªæ¼«ä¹‹æœˆ', value: 95, icon: 'ğŸ’' },
            { name: 'march', ipa: '/mÉ‘ËrtÊƒ/', desc: 'ä¸‡ç‰©å¤è‹çš„æ˜¥å¤©åºæ›²', value: 30, icon: 'ğŸŒ¸' },
            { name: 'april', ipa: '/ËˆeÉªprÉ™l/', desc: 'æ˜¥èŠ±çƒ‚æ¼«çš„ç¾å¥½æ—¶å…‰', value: 30, icon: 'ğŸŒ·' },
            { name: 'may', ipa: '/meÉª/', desc: 'é’æ˜¥æ´‹æº¢çš„æ´»åŠ›ä¹‹æœˆ', value: 20, icon: 'ğŸŒº' },
            { name: 'june', ipa: '/dÊ’uËn/', desc: 'å¤æ—¥ç‚ç‚çš„æ¿€æƒ…å²æœˆ', value: 25, icon: 'â˜€ï¸' },
            { name: 'july', ipa: '/dÊ’uËˆlaÉª/', desc: 'éª„é˜³ä¼¼ç«çš„çƒ­æƒ…ä¹‹æœˆ', value: 25, icon: 'ğŸ–ï¸' },
            { name: 'august', ipa: '/ËˆÉ”ËÉ¡É™st/', desc: 'ç§‹æ„æ¸æµ“çš„æ”¶è·å‰å¥', value: 35, icon: 'ğŸŒ¾' },
            { name: 'september', ipa: '/sepËˆtembÉ™r/', desc: 'é‡‘ç§‹é€çˆ½çš„ä¸°æ”¶ä¹‹æœˆ', value: 50, icon: 'ğŸ' },
            { name: 'october', ipa: '/É‘ËkËˆtoÊŠbÉ™r/', desc: 'é‡‘æ¡‚é£˜é¦™çš„æ”¶è·å­£èŠ‚', value: 90, icon: 'ğŸ‚' },
            { name: 'november', ipa: '/noÊŠËˆvembÉ™r/', desc: 'æ„Ÿæ©å›é¦ˆçš„æ¸©æš–ä¹‹æœˆ', value: 95, icon: 'ğŸ¦ƒ' },
            { name: 'december', ipa: '/dÉªËˆsembÉ™r/', desc: 'å¹´ç»ˆå²æœ«çš„ç¥ˆæ„¿ä¹‹æœˆ', value: 90, icon: 'ğŸ„' }
          ]
        },
        unit7: {
          name: "Unit 7 - åç¾è¡£è£…",
          icon: "ğŸ‘—",
          words: [
            { name: 'clothes', ipa: '/kloÊŠÃ°z/', desc: 'åŒ…è£¹èº«ä½“çš„åç¾å¤–è¡£', value: 75, icon: 'ğŸ‘—' },
            { name: 'trousers', ipa: '/ËˆtraÊŠzÉ™rz/', desc: 'åŒè…¿æŠ¤ç”²çš„å®ç”¨æˆ˜è¢', value: 85, icon: 'ğŸ‘–' },
            { name: 'sweater', ipa: '/ËˆswetÉ™r/', desc: 'æ¸©æš–å¦‚æ˜¥çš„ç¼–ç»‡æ‹¥æŠ±', value: 80, icon: 'ğŸ§¥' },
            { name: 'shirt', ipa: '/ÊƒÉœËrt/', desc: 'ä¼˜é›…èº«å§¿çš„è´´èº«ä¼™ä¼´', value: 30, icon: 'ğŸ‘”' },
            { name: 'shoes', ipa: '/ÊƒuËz/', desc: 'è¶³ä¸‹ç”Ÿé£çš„è¡Œèµ°ä¼™ä¼´', value: 30, icon: 'ğŸ‘' },
            { name: 'socks', ipa: '/sÉ‘Ëks/', desc: 'è¶³éƒ¨æ¸©æš–çš„æŸ”è½¯å®ˆæŠ¤', value: 25, icon: 'ğŸ§¦' },
            { name: 'hat', ipa: '/hÃ¦t/', desc: 'å¤´é¡¶é£é‡‡çš„æ—¶å°šè£…é¥°', value: 20, icon: 'ğŸ‘’' },
            { name: 'jacket', ipa: '/ËˆdÊ’Ã¦kÉªt/', desc: 'å¤–å‡ºå¿…å¤‡çš„ä¿æŠ¤é“ ç”²', value: 35, icon: 'ğŸ§¥' },
            { name: 'dress', ipa: '/dres/', desc: 'ä¼˜é›…å¥³æ€§çš„ç¾ä¸½è±¡å¾', value: 30, icon: 'ğŸ‘—' },
            { name: 'skirt', ipa: '/skÉœËrt/', desc: 'é£˜é€¸å¦‚èŠ±çš„å¥³æ€§ä¸“å±', value: 30, icon: 'ğŸ‘—' }
          ]
        },
        unit8: {
          name: "Unit 8 - é£Ÿç‰©ç››å®´",
          icon: "ğŸ½ï¸",
          words: [
            { name: 'food', ipa: '/fuËd/', desc: 'ç»´æŒç”Ÿå‘½çš„çè´µå…»æ–™', value: 25, icon: 'ğŸ½ï¸' },
            { name: 'breakfast', ipa: '/ËˆbrekfÉ™st/', desc: 'å¼€å¯ä¸€å¤©çš„èƒ½é‡æºæ³‰', value: 50, icon: 'ğŸ¥' },
            { name: 'lunch', ipa: '/lÊŒntÊƒ/', desc: 'åˆé—´è¡¥ç»™çš„è¥å…»ç››å®´', value: 30, icon: 'ğŸ±' },
            { name: 'dinner', ipa: '/ËˆdÉªnÉ™r/', desc: 'å¤œå¹•é™ä¸´çš„ä¸°ç››èšé¤', value: 35, icon: 'ğŸ½ï¸' },
            { name: 'apple', ipa: '/ËˆÃ¦pÉ™l/', desc: 'æ™ºæ…§æœå›­çš„ç”œç¾è¯±æƒ‘', value: 25, icon: 'ğŸ' },
            { name: 'banana', ipa: '/bÉ™ËˆnÃ¦nÉ™/', desc: 'çƒ­å¸¦é˜³å…‰çš„é»„é‡‘æœå®', value: 35, icon: 'ğŸŒ' },
            { name: 'orange', ipa: '/ËˆÉ”ËrÉªndÊ’/', desc: 'ç»´Cä¸°å¯Œçš„æ©™è‰²ç²¾çµ', value: 35, icon: 'ğŸŠ' },
            { name: 'milk', ipa: '/mÉªlk/', desc: 'çº¯ç™½å¦‚é›ªçš„è¥å…»ç”˜éœ²', value: 25, icon: 'ğŸ¥›' },
            { name: 'bread', ipa: '/bred/', desc: 'éº¦é¦™æµ“éƒçš„ç”Ÿæ´»ä¸»é£Ÿ', value: 30, icon: 'ğŸ' },
            { name: 'chicken', ipa: '/ËˆtÊƒÉªkÉªn/', desc: 'è›‹ç™½è´¨ä¸°å¯Œçš„ç¾å‘³çå“', value: 40, icon: 'ğŸ—' },
            { name: 'rice', ipa: '/raÉªs/', desc: 'ä¸œæ–¹æ–‡æ˜çš„ä¸»é£Ÿç‘°å®', value: 25, icon: 'ğŸš' },
            { name: 'water', ipa: '/ËˆwÉ”ËtÉ™r/', desc: 'ç”Ÿå‘½ä¹‹æºçš„çº¯å‡€æ¶²ä½“', value: 20, icon: 'ğŸ’§' }
          ]
        },
        unit9: {
          name: "Unit 9 - æ˜ŸæœŸè½®å›",
          icon: "ğŸ“…",
          words: [
            { name: 'monday', ipa: '/ËˆmÊŒndeÉª/', desc: 'æ–°å‘¨å¼€å§‹çš„å¥‹æ–—ä¹‹æ—¥', value: 35, icon: 'ğŸ“…' },
            { name: 'tuesday', ipa: '/ËˆtuËzdeÉª/', desc: 'æˆ˜ç¥æŠ¤ä½‘çš„å‹‡çŒ›ä¹‹æ—¥', value: 40, icon: 'âš”ï¸' },
            { name: 'wednesday', ipa: '/ËˆwenzdeÉª/', desc: 'æ™ºæ…§ä¹‹ç¥çš„å¯ç¤ºä¹‹æ—¥', value: 50, icon: 'ğŸ§ ' },
            { name: 'thursday', ipa: '/ËˆÎ¸ÉœËrzdeÉª/', desc: 'é›·ç¥ä¹‹é”¤çš„åŠ›é‡ä¹‹æ—¥', value: 45, icon: 'âš¡' },
            { name: 'friday', ipa: '/ËˆfraÉªdeÉª/', desc: 'çˆ±ç¥çœ·é¡¾çš„æµªæ¼«ä¹‹æ—¥', value: 35, icon: 'ğŸ’–' },
            { name: 'saturday', ipa: '/ËˆsÃ¦tÉ™rdeÉª/', desc: 'å†œç¥èµç¦çš„ä¸°æ”¶ä¹‹æ—¥', value: 50, icon: 'ğŸŒ¾' },
            { name: 'sunday', ipa: '/ËˆsÊŒndeÉª/', desc: 'å¤ªé˜³ç¥ç…§è€€çš„å…‰æ˜ä¹‹æ—¥', value: 35, icon: 'â˜€ï¸' },
            { name: 'today', ipa: '/tÉ™ËˆdeÉª/', desc: 'å½“ä¸‹æ­¤åˆ»çš„çè´µæ—¶å…‰', value: 30, icon: 'ğŸ“' },
            { name: 'tomorrow', ipa: '/tÉ™ËˆmÉ‘ËroÊŠ/', desc: 'å……æ»¡å¸Œæœ›çš„æœªæ¥ä¹‹æ—¥', value: 45, icon: 'ğŸŒ…' },
            { name: 'yesterday', ipa: '/ËˆjestÉ™rdeÉª/', desc: 'å·²æˆå›å¿†çš„æ˜¨æ—¥æ—¶å…‰', value: 50, icon: 'ğŸ“¸' },
            { name: 'weekend', ipa: '/ËŒwiËkËˆend/', desc: 'æ”¾æ¾èº«å¿ƒçš„ä¼‘æ¯æ—¶å…‰', value: 40, icon: 'ğŸ–ï¸' }
          ]
        }
      };

      // ç”Ÿæˆå…¼å®¹çš„éš¾åº¦åˆ†çº§ç³»ç»Ÿ (ä¿æŒå‘åå…¼å®¹)
      const TREASURES = {
        bronze: [],
        silver: [],
        gold: [
          { name: 'mysterious', ipa: '/mÉªËˆstÉªÉ™riÉ™s/', desc: 'å……æ»¡æœªçŸ¥é­”åŠ›çš„ç¥ç§˜ç‰©å“', value: 200, icon: 'ğŸ­' },
          { name: 'magnificent', ipa: '/mÃ¦gËˆnÉªfÉ™sÉ™nt/', desc: 'ä»¤äººå¹ä¸ºè§‚æ­¢çš„åä¸½å®ç‰©', value: 250, icon: 'ğŸ‘‘' },
          { name: 'extraordinary', ipa: '/ÉªkËˆstrÉ”ËrdÉ™ËŒnÉ›ri/', desc: 'è¶…è¶Šå‡¡ä¿—çš„éå‡¡åœ£å™¨', value: 300, icon: 'âœ¨' },
          { name: 'archaeological', ipa: '/ËŒÉ‘ËrkiÉ™ËˆlÉ’dÊ’ÉªkÉ™l/', desc: 'è€ƒå¤å­¦å®¶æ¢¦å¯ä»¥æ±‚çš„æ–‡ç‰©', value: 350, icon: 'ğŸ›ï¸' },
          { name: 'philosopher', ipa: '/fÉ™ËˆlÉ’sÉ™fÉ™r/', desc: 'å“²å­¦å®¶çš„è´¤è€…ä¹‹çŸ³', value: 280, icon: 'ğŸ’' }
        ],
        diamond: [
          { name: 'incomprehensible', ipa: '/ËŒÉªnkÉ’mprÉªËˆhÉ›nsÉ™bÉ™l/', desc: 'è¶…è¶Šäººç±»ç†è§£çš„ç»ˆæç¥å™¨', value: 500, icon: 'ğŸŒŸ' },
          { name: 'transcendental', ipa: '/ËŒtrÃ¦nsÉ›nËˆdÉ›ntÉ™l/', desc: 'è¶…è¶Šç‰©è´¨ä¸–ç•Œçš„ç²¾ç¥å®è—', value: 600, icon: 'ğŸ”±' },
          { name: 'metamorphosis', ipa: '/ËŒmÉ›tÉ™ËˆmÉ”ËrfÉ™sÉªs/', desc: 'èƒ½å¤Ÿæ”¹å˜ä¸€åˆ‡çš„å˜å½¢æ³•å™¨', value: 550, icon: 'ğŸ¦‹' },
          { name: 'philosophical', ipa: '/ËŒfÉªlÉ™ËˆsÉ’fÉªkÉ™l/', desc: 'åŒ…å«å®‡å®™çœŸç†çš„æ™ºæ…§ç»“æ™¶', value: 650, icon: 'ğŸ§¿' },
          { name: 'pronunciation', ipa: '/prÉ™ËŒnÊŒnsiËˆeÉªÊƒÉ™n/', desc: 'æŒæ§è¯­è¨€é­”æ³•çš„å‘éŸ³å®å…¸', value: 700, icon: 'ğŸ“–' }
        ]
      };

      // åˆå§‹åŒ–å…¼å®¹æ€§æ•°æ® - å°†å•å…ƒå•è¯æŒ‰ä»·å€¼åˆ†é…åˆ°ä¸åŒéš¾åº¦
      function initializeTreasures() {
        // Clear existing arrays
        TREASURES.bronze = [];
        TREASURES.silver = [];
        
        // Distribute words from units by value ranges
        Object.values(UNIT_TREASURES).forEach(unitData => {
          unitData.words.forEach(word => {
            if (word.value <= 40) {
              TREASURES.bronze.push(word);
            } else if (word.value <= 100) {
              TREASURES.silver.push(word);
            }
            // Keep gold and diamond as advanced words
          });
        });
      }

      // è·å–å½“å‰éš¾åº¦ç­‰çº§çš„å®ç‰© (ä»…ç”¨äºå‘åå…¼å®¹)
      function getCurrentTreasureLevel() {
        if (state.level <= 5) return 'bronze';
        if (state.level <= 10) return 'silver';
        if (state.level <= 15) return 'gold';
        return 'diamond';
      }

      // --- Speech Recognition Setup ---
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      let recognizer = null;
      let permissionGranted = false;
      
      if (SpeechRecognition && navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(() => {
            permissionGranted = true;
            ui.feedback.textContent = 'ğŸ™ï¸ éº¦å…‹é£æƒé™å·²è·å–ï¼Œå¼€å§‹ä½ çš„å¯»å®ä¹‹æ—…ï¼';
          })
          .catch(() => {
            ui.compatMsg.textContent = 'ğŸš« éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½è¿›è¡Œè¯­éŸ³è¯†åˆ«å¯»å®';
            ui.compatMsg.style.display = 'block';
          });
      }

      if (SpeechRecognition) {
        recognizer = new SpeechRecognition();
        recognizer.lang = 'en-US';
        recognizer.continuous = false;
        recognizer.interimResults = false;

        recognizer.onstart = () => {
          state.recognizing = true;
          ui.speakBtn.textContent = 'ğŸ¯ æ­£åœ¨è¯†åˆ«é­”å’’...';
          ui.speakBtn.disabled = true;
          ui.feedback.textContent = 'ğŸ“¢ å¤§å£°è¯´å‡ºå®ç‰©çš„è‹±æ–‡åç§°...';
          ui.feedback.className = 'feedback';
        };

        recognizer.onresult = (event) => {
          const spokenText = event.results[0][0].transcript;
          checkTreasureName(spokenText);
        };

        recognizer.onerror = (event) => {
          ui.feedback.textContent = `ğŸ’¥ é­”å’’è¯†åˆ«å¤±è´¥: ${event.error}`;
          ui.feedback.className = 'feedback error';
        };

        recognizer.onend = () => {
          state.recognizing = false;
          ui.speakBtn.textContent = 'ğŸ™ï¸ è¯´å‡ºå®ç‰©çœŸåï¼Œè·å¾—å®è—';
          ui.speakBtn.disabled = false;
        };
      } else {
        ui.compatMsg.textContent = 'âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥';
        ui.compatMsg.style.display = 'block';
        ui.speakBtn.style.display = 'none';
      }

      // --- Shop Functions ---
      function renderShop() {
        ui.shopCoins.textContent = state.coins;
        
        // æ¸²æŸ“æ‹¥æœ‰çš„é“å…·
        if (state.ownedItems.length === 0) {
          ui.ownedItems.innerHTML = '<span class="owned-item">æš‚æ— é“å…·</span>';
        } else {
          ui.ownedItems.innerHTML = state.ownedItems
            .map(item => `<span class="owned-item">${item.icon} ${item.name} (${item.uses > 0 ? item.uses + 'æ¬¡' : 'æ°¸ä¹…'})</span>`)
            .join('');
        }
        
        // æ¸²æŸ“å•†å“
        ui.shopItemsContainer.innerHTML = SHOP_ITEMS.map(item => {
          const canAfford = state.coins >= item.price;
          const alreadyOwned = state.ownedItems.some(owned => owned.id === item.id && owned.permanent);
          
          return `
            <div class="shop-item">
              <div class="shop-item-icon">${item.icon}</div>
              <div class="shop-item-info">
                <div class="shop-item-name">${item.name}</div>
                <div class="shop-item-desc">${item.desc}</div>
                <div class="shop-item-price">ä»·æ ¼: ${item.price} é‡‘å¸</div>
              </div>
              <button 
                class="shop-buy-btn" 
                data-item-id="${item.id}"
                ${!canAfford || alreadyOwned ? 'disabled' : ''}
              >
                ${alreadyOwned ? 'å·²æ‹¥æœ‰' : (canAfford ? 'è´­ä¹°' : 'é‡‘å¸ä¸è¶³')}
              </button>
            </div>
          `;
        }).join('');
        
        // ç»‘å®šè´­ä¹°æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.shop-buy-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const itemId = e.target.dataset.itemId;
            buyItem(itemId);
          });
        });
      }

      function buyItem(itemId) {
        const item = SHOP_ITEMS.find(i => i.id === itemId);
        if (!item || state.coins < item.price) {
          playSound('error');
          return;
        }
        
        state.coins -= item.price;
        state.ownedItems.push({...item});
        
        // æ’­æ”¾è´­ä¹°éŸ³æ•ˆ
        playSound('coin');
        
        // åº”ç”¨é“å…·æ•ˆæœ
        applyItemEffect(item);
        
        ui.coins.textContent = state.coins;
        renderShop();
        
        ui.feedback.textContent = `ğŸ‰ æˆåŠŸè´­ä¹° ${item.name}ï¼`;
        ui.feedback.className = 'feedback success';
      }

      function applyItemEffect(item) {
        switch (item.effect) {
          case 'gold_boost':
            state.activeEffects.goldMultiplier = 2;
            state.activeEffects.goldBoostUses = item.uses;
            break;
          case 'hint':
            state.activeEffects.hintAvailable = true;
            addHintButton();
            break;
          case 'exp_boost':
            state.activeEffects.expBoost = 0.8; // éœ€è¦80%çš„å®ç‰©å°±èƒ½å‡çº§
            break;
          case 'luck':
            state.activeEffects.luckUses = item.uses;
            break;
          case 'voice_boost':
            // è¯­éŸ³è¯†åˆ«å¢å¼ºï¼ˆåœ¨è¯†åˆ«æ—¶å¤„ç†ï¼‰
            state.activeEffects.voiceBoost = true;
            break;
        }
      }

      function addHintButton() {
        if (document.getElementById('hint-btn')) return;
        
        const hintBtn = document.createElement('button');
        hintBtn.id = 'hint-btn';
        hintBtn.className = 'treasure-btn';
        hintBtn.style.background = 'linear-gradient(145deg, var(--treasure-silver), #e8e8e8)';
        hintBtn.style.color = '#2d1b0a';
        hintBtn.style.marginBottom = '10px';
        hintBtn.textContent = 'ğŸ”® è·å–æç¤º';
        
        hintBtn.addEventListener('click', () => {
          if (state.activeEffects.hintAvailable && state.currentTreasure) {
            const hint = state.currentTreasure.name.charAt(0).toUpperCase() + '***';
            ui.feedback.textContent = `ğŸ’¡ æç¤ºï¼šå•è¯ä»¥ "${hint}" å¼€å¤´`;
            ui.feedback.className = 'feedback';
            
            // æ¶ˆè€—æç¤ºæ¬¡æ•°
            const hintItem = state.ownedItems.find(item => item.id === 'hint_crystal');
            if (hintItem) {
              hintItem.uses--;
              if (hintItem.uses <= 0) {
                state.ownedItems = state.ownedItems.filter(item => item.id !== 'hint_crystal');
                state.activeEffects.hintAvailable = false;
                hintBtn.remove();
              }
            }
          }
        });
        
        document.querySelector('.action-buttons').insertBefore(hintBtn, ui.speakBtn);
      }

      function openShop() {
        renderShop();
        ui.shopModal.style.display = 'flex';
      }

      function closeShop() {
        ui.shopModal.style.display = 'none';
      }

      // --- Unit System Functions ---
      function initializeUnitSystem() {
        // Initialize unit progress
        Object.keys(UNIT_TREASURES).forEach(unitId => {
          state.unitProgress[unitId] = {
            completed: 0,
            total: UNIT_TREASURES[unitId].words.length,
            masteredWords: new Set()
          };
        });
        
        renderUnitGrid();
        updateCurrentUnitDisplay();
      }

      function renderUnitGrid() {
        const units = Object.entries(UNIT_TREASURES).map(([unitId, unitData]) => {
          const progress = state.unitProgress[unitId];
          const completionRate = Math.round((progress.completed / progress.total) * 100);
          const isActive = state.selectedUnit === unitId;
          const isCompleted = progress.completed === progress.total;
          
          return `
            <div class="unit-card ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}" 
                 data-unit-id="${unitId}" 
                 title="${unitData.name}: ${progress.completed}/${progress.total} å·²æŒæ¡">
              <span class="unit-icon">${unitData.icon}</span>
              <div class="unit-name">${unitData.name.split(' - ')[1]}</div>
              <div class="unit-progress">${isCompleted ? 'âœ…' : completionRate + '%'}</div>
            </div>
          `;
        });
        
        ui.unitGrid.innerHTML = units.join('');
        
        // Add click listeners to unit cards
        document.querySelectorAll('.unit-card').forEach(card => {
          card.addEventListener('click', () => {
            const unitId = card.dataset.unitId;
            selectUnit(unitId);
            playSound('click');
          });
        });
      }

      function selectUnit(unitId) {
        state.selectedUnit = unitId;
        renderUnitGrid();
        updateCurrentUnitDisplay();
        loadNewTreasure(); // Load a new treasure from the selected unit
        
        // Collapse unit grid after selection
        state.unitGridExpanded = false;
        ui.unitGrid.classList.remove('expanded');
        ui.unitToggle.textContent = 'å±•å¼€å•å…ƒé€‰æ‹©';
        
        ui.feedback.textContent = `ğŸ¯ å·²åˆ‡æ¢åˆ° ${UNIT_TREASURES[unitId].name}ï¼å‡†å¤‡å¼€å§‹å­¦ä¹ å§ï¼`;
        ui.feedback.className = 'feedback';
      }

      function resetUnitSelection() {
        state.selectedUnit = null;
        renderUnitGrid();
        updateCurrentUnitDisplay();
        loadNewTreasure();
        
        ui.feedback.textContent = 'ğŸŒŸ å·²åˆ‡æ¢åˆ°å…¨éƒ¨å•å…ƒæ··åˆæ¨¡å¼ï¼';
        ui.feedback.className = 'feedback';
      }

      function updateCurrentUnitDisplay() {
        if (state.selectedUnit) {
          const unitData = UNIT_TREASURES[state.selectedUnit];
          const progress = state.unitProgress[state.selectedUnit];
          const remaining = progress.total - progress.completed;
          
          if (progress.completed === progress.total) {
            ui.currentUnitInfo.textContent = `ğŸ¯ å½“å‰ï¼š${unitData.name} âœ… å·²å®Œæˆï¼`;
          } else {
            ui.currentUnitInfo.textContent = `ğŸ¯ å½“å‰ï¼š${unitData.name} (${progress.completed}/${progress.total}) è¿˜å‰©${remaining}ä¸ª`;
          }
        } else {
          // Show overall progress in mixed mode
          let totalCompleted = 0;
          let totalWords = 0;
          Object.values(state.unitProgress).forEach(progress => {
            totalCompleted += progress.completed;
            totalWords += progress.total;
          });
          ui.currentUnitInfo.textContent = `ğŸ¯ å½“å‰ï¼šå…¨éƒ¨å•å…ƒæ··åˆæ¨¡å¼ (${totalCompleted}/${totalWords})`;
        }
      }

      function toggleUnitGrid() {
        state.unitGridExpanded = !state.unitGridExpanded;
        if (state.unitGridExpanded) {
          ui.unitGrid.classList.add('expanded');
          ui.unitToggle.textContent = 'æ”¶èµ·å•å…ƒé€‰æ‹©';
        } else {
          ui.unitGrid.classList.remove('expanded');
          ui.unitToggle.textContent = 'å±•å¼€å•å…ƒé€‰æ‹©';
        }
        playSound('click');
      }

      function getCurrentTreasureSource() {
        if (state.selectedUnit) {
          // Return only unmastered words from selected unit
          const unitData = UNIT_TREASURES[state.selectedUnit];
          const unitProgress = state.unitProgress[state.selectedUnit];
          
          // Filter out already mastered words
          const unmasteredWords = unitData.words.filter(word => 
            !unitProgress.masteredWords.has(word.name)
          );
          
          // If all words are mastered, congratulate and switch to mixed mode
          if (unmasteredWords.length === 0) {
            ui.feedback.textContent = `ğŸ‰ æ­å–œï¼ä½ å·²å®Œå…¨æŒæ¡${unitData.name}çš„æ‰€æœ‰å•è¯ï¼è‡ªåŠ¨åˆ‡æ¢åˆ°æ··åˆæ¨¡å¼ç»§ç»­æŒ‘æˆ˜ï¼`;
            ui.feedback.className = 'feedback success';
            playSound('level');
            
            // Reset to mixed mode after 3 seconds
            setTimeout(() => {
              resetUnitSelection();
            }, 3000);
            
            // Return all words as fallback for now
            const allWords = [];
            Object.values(UNIT_TREASURES).forEach(unitData => {
              allWords.push(...unitData.words);
            });
            return allWords;
          }
          
          return unmasteredWords;
        } else {
          // Return all words from all units (mixed mode) - but prioritize unmastered ones
          const unmasteredWords = [];
          const masteredWords = [];
          
          Object.entries(UNIT_TREASURES).forEach(([unitId, unitData]) => {
            const unitProgress = state.unitProgress[unitId];
            unitData.words.forEach(word => {
              if (unitProgress.masteredWords.has(word.name)) {
                masteredWords.push(word);
              } else {
                unmasteredWords.push(word);
              }
            });
          });
          
          // Return unmastered words first, with some mastered words for review (20% chance)
          if (unmasteredWords.length > 0) {
            // 80% unmastered, 20% mastered for review
            if (Math.random() < 0.8 || masteredWords.length === 0) {
              return unmasteredWords;
            } else {
              return masteredWords;
            }
          } else {
            // All words mastered - return all for continued practice
            return masteredWords;
          }
        }
      }

      function markWordAsCompleted(wordName) {
        // Find which unit this word belongs to
        const unitId = findWordUnit(wordName);
        if (unitId && !state.unitProgress[unitId].masteredWords.has(wordName)) {
          state.unitProgress[unitId].masteredWords.add(wordName);
          state.unitProgress[unitId].completed++;
          
          // Update unit display if we're in that unit
          if (state.selectedUnit === unitId) {
            updateCurrentUnitDisplay();
          }
          
          renderUnitGrid();
        }
      }

      function findWordUnit(wordName) {
        for (const [unitId, unitData] of Object.entries(UNIT_TREASURES)) {
          if (unitData.words.some(word => word.name === wordName)) {
            return unitId;
          }
        }
        return null;
      }

      // --- Game Functions ---
      function loadNewTreasure() {
        // Use unit-based treasure source instead of difficulty levels
        const availableTreasures = getCurrentTreasureSource();
        
        // Safety check: if no treasures available, fallback to all words
        if (!availableTreasures || availableTreasures.length === 0) {
          console.warn('No available treasures, falling back to all words');
          const allWords = [];
          Object.values(UNIT_TREASURES).forEach(unitData => {
            allWords.push(...unitData.words);
          });
          const randomTreasure = allWords[Math.floor(Math.random() * allWords.length)];
          state.currentTreasure = randomTreasure;
        } else {
          const randomTreasure = availableTreasures[Math.floor(Math.random() * availableTreasures.length)];
          state.currentTreasure = randomTreasure;
        }
        
        ui.treasureName.textContent = state.currentTreasure.name;
        ui.treasurePhonetic.textContent = state.currentTreasure.ipa;
        ui.treasureDescription.textContent = state.currentTreasure.desc;
        ui.treasureValue.textContent = `ä»·å€¼: ${state.currentTreasure.value}é‡‘å¸`;
        ui.treasureChest.textContent = state.currentTreasure.icon;
        
        // æ ¹æ®å®ç‰©ç­‰çº§æ”¹å˜å®ç®±é¢œè‰²
        const colors = {
          bronze: 'linear-gradient(145deg, #cd7f32, #8b4513)',
          silver: 'linear-gradient(145deg, #c0c0c0, #808080)',
          gold: 'linear-gradient(145deg, #ffd700, #b8860b)',
          diamond: 'linear-gradient(145deg, #b9f2ff, #87ceeb)'
        };
        ui.treasureChest.style.background = colors[level];
      }

      function checkTreasureName(inputText) {
        const targetName = state.currentTreasure.name;
        const userInput = inputText.trim().toLowerCase();
        
        if (userInput === targetName.toLowerCase()) {
          handleCorrectAnswer();
        } else {
          playSound('error');
          ui.feedback.textContent = `âŒ å’’è¯­é”™è¯¯ï¼ä½ è¯´çš„æ˜¯ "${inputText}"ï¼Œæ­£ç¡®çš„åº”è¯¥æ˜¯ "${targetName}"`;
          ui.feedback.className = 'feedback error';
          
          // Auto-play correct pronunciation after 1 second
          setTimeout(() => {
            speakWord(targetName);
            ui.feedback.textContent = `ğŸ”Š æ­£åœ¨æ’­æ”¾æ­£ç¡®å‘éŸ³ï¼š"${targetName}"`;
          }, 1000);
        }
      }

      // Text-to-Speech function for pronunciation demonstration
      function speakWord(word, isManual = false) {
        if ('speechSynthesis' in window) {
          // Cancel any ongoing speech
          speechSynthesis.cancel();
          
          // Disable pronunciation button temporarily
          if (ui.pronunciationBtn) {
            ui.pronunciationBtn.disabled = true;
            ui.pronunciationBtn.textContent = 'ğŸ”Š æ’­æ”¾ä¸­...';
          }
          
          const utterance = new SpeechSynthesisUtterance(word);
          utterance.lang = 'en-US';
          utterance.rate = 0.8; // Slightly slower for clearer pronunciation
          utterance.pitch = 1;
          utterance.volume = 0.8;
          
          // Load voices if not already loaded
          let voices = speechSynthesis.getVoices();
          if (voices.length === 0) {
            // Wait for voices to load
            speechSynthesis.addEventListener('voiceschanged', () => {
              voices = speechSynthesis.getVoices();
            });
          }
          
          // Try to use a high-quality English voice
          const englishVoice = voices.find(voice => 
            voice.lang.startsWith('en') && (
              voice.name.includes('Google') || 
              voice.name.includes('Microsoft') ||
              voice.name.includes('Alex') ||
              voice.name.includes('Samantha') ||
              voice.name.includes('Daniel') ||
              voice.name.includes('Karen')
            )
          ) || voices.find(voice => voice.lang.startsWith('en'));
          
          if (englishVoice) {
            utterance.voice = englishVoice;
          }
          
          utterance.onend = () => {
            // Re-enable pronunciation button
            if (ui.pronunciationBtn) {
              ui.pronunciationBtn.disabled = false;
              ui.pronunciationBtn.textContent = 'ğŸ”Š å¬å‘éŸ³';
            }
            
            if (isManual) {
              ui.feedback.textContent = `ğŸµ å·²æ’­æ”¾"${word}"çš„å‘éŸ³ï¼Œç°åœ¨è¯•ç€è¯´å‡ºæ¥å§ï¼`;
              ui.feedback.className = 'feedback';
            } else {
              ui.feedback.textContent = `ğŸ’¡ å¬æ¸…æ¥šäº†å—ï¼Ÿå†è¯•ä¸€æ¬¡è¯´å‡ºï¼š"${word}"`;
              ui.feedback.className = 'feedback';
            }
          };
          
          utterance.onerror = (event) => {
            console.warn('Speech synthesis error:', event.error);
            
            // Re-enable pronunciation button
            if (ui.pronunciationBtn) {
              ui.pronunciationBtn.disabled = false;
              ui.pronunciationBtn.textContent = 'ğŸ”Š å¬å‘éŸ³';
            }
            
            ui.feedback.textContent = `ğŸ“– è¯­éŸ³æ’­æ”¾å¤±è´¥ï¼Œè¯·çœ‹éŸ³æ ‡ï¼š"${word}" ${state.currentTreasure.ipa}`;
            ui.feedback.className = 'feedback';
          };
          
          // Play the word
          speechSynthesis.speak(utterance);
        } else {
          // Fallback when speech synthesis is not available
          ui.feedback.textContent = `ğŸ“– æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾ï¼Œè¯·çœ‹éŸ³æ ‡ï¼š${state.currentTreasure.ipa}`;
          ui.feedback.className = 'feedback';
        }
      }

      function handleCorrectAnswer() {
        const reward = state.currentTreasure.value;
        const bonusMultiplier = 1 + (state.level - 1) * 0.1;
        let finalReward = Math.floor(reward * bonusMultiplier);
        
        // åº”ç”¨é»„é‡‘è¯æ°´æ•ˆæœ
        if (state.activeEffects.goldBoostUses > 0) {
          finalReward *= state.activeEffects.goldMultiplier;
          state.activeEffects.goldBoostUses--;
          if (state.activeEffects.goldBoostUses <= 0) {
            state.activeEffects.goldMultiplier = 1;
          }
        }
        
        state.coins += finalReward;
        state.treasuresFound++;
        state.inventory.push(state.currentTreasure);
        
        // Mark word as completed in unit progress
        markWordAsCompleted(state.currentTreasure.name);
        
        // æ’­æ”¾æˆåŠŸéŸ³æ•ˆå’Œé‡‘å¸éŸ³æ•ˆ
        playSound('success');
        setTimeout(() => playSound('coin'), 300);
        
        // æ·»åŠ åº†ç¥åŠ¨ç”»
        ui.treasureChest.classList.add('celebrate');
        ui.coins.classList.add('coin-earned');
        
        ui.coins.textContent = state.coins;
        ui.treasures.textContent = state.treasuresFound;
        ui.feedback.textContent = `ğŸ‰ æ­å–œï¼ä½ è·å¾—äº† ${state.currentTreasure.name}ï¼+${finalReward} é‡‘å¸`;
        ui.feedback.className = 'feedback success';
        
        // å‡çº§æ£€æŸ¥ï¼ˆè€ƒè™‘ç»éªŒæŠ¤ç¬¦æ•ˆæœï¼‰
        const upgradeThreshold = Math.ceil(5 * state.activeEffects.expBoost);
        if (state.treasuresFound % upgradeThreshold === 0) {
          state.level++;
          ui.level.textContent = state.level;
          setTimeout(() => {
            playSound('level');
            ui.feedback.textContent = `â­ æ­å–œå‡çº§åˆ° ${state.level} çº§ï¼è§£é”æ›´çè´µçš„å®è—ï¼`;
            ui.feedback.className = 'feedback success';
          }, 2000);
        }
        
        // æ¸…é™¤åŠ¨ç”»ç±»
        setTimeout(() => {
          ui.treasureChest.classList.remove('celebrate');
          ui.coins.classList.remove('coin-earned');
        }, 600);
        
        // 3ç§’ååŠ è½½æ–°å®ç‰©
        setTimeout(() => {
          loadNewTreasure();
          ui.feedback.textContent = 'ğŸ” å‘ç°æ–°çš„å®è—ï¼å‡†å¤‡å¥½è¯´å‡ºå®ƒçš„çœŸåäº†å—ï¼Ÿ';
          ui.feedback.className = 'feedback';
        }, 3000);
      }

      // --- Event Listeners ---
      ui.speakBtn.addEventListener('click', () => {
        playSound('click');
        if (recognizer && !state.recognizing) {
          recognizer.start();
        }
      });

      ui.submitBtn.addEventListener('click', () => {
        playSound('click');
        const inputText = ui.manualInput.value;
        if (inputText.trim()) {
          checkTreasureName(inputText);
          ui.manualInput.value = '';
        }
      });
      
      ui.manualInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          ui.submitBtn.click();
        }
      });

      ui.shopBtn.addEventListener('click', () => {
        playSound('click');
        openShop();
      });
      
      ui.shopClose.addEventListener('click', () => {
        playSound('click');
        closeShop();
      });
      
      // ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­å•†åº—
      ui.shopModal.addEventListener('click', (e) => {
        if (e.target === ui.shopModal) {
          closeShop();
        }
      });

      // Unit system event listeners
      ui.unitToggle.addEventListener('click', toggleUnitGrid);
      ui.resetUnitBtn.addEventListener('click', () => {
        playSound('click');
        resetUnitSelection();
      });

      // Pronunciation button event listener
      ui.pronunciationBtn.addEventListener('click', () => {
        playSound('click');
        if (state.currentTreasure) {
          speakWord(state.currentTreasure.name, true);
        }
      });

      // --- Initialize Game ---
      initializeTreasures(); // Initialize compatibility system
      initializeUnitSystem();
      loadNewTreasure();
    });
  </script>
</body>
</html>