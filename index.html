<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Treasure Hunter ¬∑ Êë∏ÈáëËÉåÂçïËØç</title>
  <style>
    :root {
      --cave-bg: linear-gradient(135deg, #2d1b0a 0%, #1a0d05 100%);
      --treasure-gold: #ffd700;
      --treasure-bronze: #cd7f32;
      --treasure-silver: #c0c0c0;
      --treasure-diamond: #b9f2ff;
      --ancient-stone: #4a4a4a;
      --parchment: #f4e4bc;
      --shadow-dark: rgba(0,0,0,0.8);
      --glow-gold: 0 0 20px rgba(255,215,0,0.5);
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--cave-bg);
      font-family: 'Georgia', 'Times New Roman', serif;
      color: var(--parchment);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(255,215,0,0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255,215,0,0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255,255,255,0.02) 0%, transparent 50%);
    }
    
    #game-container {
      width: min(95vw, 600px);
      background: linear-gradient(145deg, #3d2914, #2a1a0a);
      border-radius: 20px;
      border: 3px solid var(--treasure-gold);
      box-shadow: 
        var(--glow-gold),
        inset 0 2px 10px rgba(255,215,0,0.1),
        0 20px 40px var(--shadow-dark);
      position: relative;
      overflow: hidden;
    }
    
    #game-container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--treasure-gold), var(--treasure-bronze), var(--treasure-gold));
      z-index: -1;
      border-radius: 20px;
    }
    
    .header {
      background: linear-gradient(90deg, var(--treasure-gold), #ffed4a, var(--treasure-gold));
      color: #2d1b0a;
      padding: 15px 25px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      border-bottom: 2px solid var(--treasure-bronze);
    }
    
    .stats-bar {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      padding: 20px 25px;
      background: linear-gradient(180deg, #4a3219, #3d2914);
      border-bottom: 1px solid var(--treasure-bronze);
    }
    
    .stat-item {
      text-align: center;
      padding: 10px;
      background: linear-gradient(145deg, #5a4028, #4a3219);
      border-radius: 15px;
      border: 2px solid var(--treasure-bronze);
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .stat-icon {
      font-size: 24px;
      margin-bottom: 5px;
      display: block;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: var(--treasure-gold);
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
    }
    
    .treasure-chamber {
      padding: 30px 25px;
      text-align: center;
      background: radial-gradient(circle at center, #4a3219, #3d2914);
      position: relative;
    }
    
    .treasure-chest {
      width: 120px;
      height: 120px;
      background: linear-gradient(145deg, #8b4513, #a0522d);
      border: 4px solid var(--treasure-gold);
      border-radius: 15px 15px 25px 25px;
      margin: 0 auto 20px;
      position: relative;
      box-shadow: var(--glow-gold);
      animation: treasureGlow 3s infinite alternate;
    }
    
    @keyframes treasureGlow {
      0% { box-shadow: var(--glow-gold); }
      100% { box-shadow: 0 0 30px rgba(255,215,0,0.8); }
    }
    
    .treasure-chest::before {
      content: 'üíé';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 40px;
      animation: sparkle 2s infinite;
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); }
      50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
    }
    
    .treasure-info {
      background: rgba(116, 88, 48, 0.6);
      border: 2px solid var(--treasure-gold);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      backdrop-filter: blur(5px);
    }
    
    .treasure-name {
      font-size: 36px;
      font-weight: bold;
      color: var(--treasure-gold);
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .treasure-phonetic {
      font-size: 18px;
      color: var(--treasure-silver);
      margin-bottom: 15px;
      font-style: italic;
    }
    
    .treasure-description {
      font-size: 16px;
      line-height: 1.5;
      opacity: 0.9;
    }
    
    .treasure-value {
      display: inline-block;
      background: linear-gradient(45deg, var(--treasure-gold), #ffed4a);
      color: #2d1b0a;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      margin-top: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .action-buttons {
      display: grid;
      gap: 15px;
      padding: 25px;
      background: linear-gradient(180deg, #3d2914, #2d1b0a);
    }
    
    .treasure-btn {
      padding: 15px;
      border: none;
      border-radius: 15px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      font-family: inherit;
    }
    
    .speak-btn {
      background: linear-gradient(145deg, var(--treasure-gold), #ffed4a);
      color: #2d1b0a;
      border: 3px solid var(--treasure-bronze);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    .speak-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
    }
    
    .speak-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .manual-input {
      display: flex;
      gap: 10px;
    }
    
    .manual-input input {
      flex: 1;
      padding: 15px;
      border: 2px solid var(--treasure-bronze);
      border-radius: 12px;
      background: rgba(74, 57, 25, 0.8);
      color: var(--parchment);
      font-size: 16px;
      font-family: inherit;
    }
    
    .manual-input input:focus {
      outline: none;
      border-color: var(--treasure-gold);
      box-shadow: 0 0 10px rgba(255,215,0,0.3);
    }
    
    .submit-btn {
      background: linear-gradient(145deg, var(--treasure-silver), #e8e8e8);
      color: #2d1b0a;
      border: 2px solid var(--ancient-stone);
      padding: 15px 25px;
      border-radius: 12px;
    }
    
    .submit-btn:hover {
      background: linear-gradient(145deg, #e8e8e8, var(--treasure-silver));
      transform: translateY(-1px);
    }
    
    .feedback {
      padding: 20px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-top: 1px solid var(--treasure-bronze);
      background: rgba(45, 27, 10, 0.5);
    }
    
    .feedback.success {
      color: var(--treasure-gold);
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
      animation: successPulse 0.6s ease-out;
    }
    
    .feedback.error {
      color: #ff6b6b;
      text-shadow: 0 0 10px rgba(255,107,107,0.5);
    }
    
    @keyframes successPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(30px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideInRight {
      0% {
        opacity: 0;
        transform: translateX(30px);
      }
      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes coinSpin {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(360deg); }
    }
    
    @keyframes celebrate {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.1) rotate(-5deg); }
      75% { transform: scale(1.1) rotate(5deg); }
    }
    
    @keyframes modalSlideIn {
      0% {
        opacity: 0;
        transform: scale(0.7) translateY(-50px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    /* È°µÈù¢Âä†ËΩΩÂä®Áîª */
    #game-container {
      animation: fadeInUp 0.8s ease-out;
    }
    
    .stats-bar {
      animation: slideInRight 0.6s ease-out 0.2s both;
    }
    
    .treasure-chamber {
      animation: fadeInUp 0.6s ease-out 0.4s both;
    }
    
    .action-buttons {
      animation: fadeInUp 0.6s ease-out 0.6s both;
    }
    
    /* Ëé∑ÂæóÈáëÂ∏ÅÂä®Áîª */
    .coin-earned {
      animation: coinSpin 0.5s ease-out;
    }
    
    /* Â∫ÜÁ•ùÂä®Áîª */
    .celebrate {
      animation: celebrate 0.6s ease-out;
    }
    
    /* ÂïÜÂ∫óÊ®°ÊÄÅÂä®Áîª */
    .shop-content {
      animation: modalSlideIn 0.3s ease-out;
    }
    
    .shop-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(145deg, var(--treasure-gold), #ffed4a);
      border: 3px solid var(--treasure-bronze);
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow: var(--glow-gold);
      z-index: 1000;
      transition: transform 0.3s ease;
      animation: float 3s ease-in-out infinite;
    }
    
    .shop-btn:hover {
      transform: scale(1.1);
    }
    
    /* Unit Selector Styles */
    .unit-selector {
      background: linear-gradient(135deg, #4a3219, #3d2914);
      border-bottom: 2px solid var(--treasure-bronze);
      padding: 15px 20px;
    }
    
    .unit-title {
      color: var(--treasure-gold);
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .unit-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .unit-grid.expanded {
      max-height: 400px;
    }
    
    .unit-card {
      background: linear-gradient(145deg, rgba(116, 88, 48, 0.6), rgba(74, 57, 25, 0.8));
      border: 2px solid var(--treasure-bronze);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .unit-card:hover {
      border-color: var(--treasure-gold);
      background: linear-gradient(145deg, rgba(116, 88, 48, 0.8), rgba(74, 57, 25, 1));
      transform: translateY(-2px);
    }
    
    .unit-card.active {
      border-color: var(--treasure-gold);
      background: linear-gradient(145deg, var(--treasure-gold), #ffed4a);
      color: #2d1b0a;
      box-shadow: var(--glow-gold);
    }
    
    .unit-card.completed {
      background: linear-gradient(145deg, var(--treasure-silver), #e8e8e8);
      border-color: var(--treasure-silver);
    }
    
    .unit-icon {
      font-size: 20px;
      margin-bottom: 5px;
      display: block;
    }
    
    .unit-name {
      font-size: 12px;
      font-weight: bold;
      line-height: 1.2;
    }
    
    .unit-progress {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--treasure-gold);
      color: #2d1b0a;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }
    
    .unit-toggle {
      background: linear-gradient(145deg, var(--treasure-bronze), #8b4513);
      border: none;
      color: var(--parchment);
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 0 auto;
      display: block;
      transition: all 0.3s ease;
    }
    
    .unit-toggle:hover {
      background: linear-gradient(145deg, var(--treasure-gold), #ffed4a);
      color: #2d1b0a;
    }
    
    .current-unit-display {
      background: rgba(116, 88, 48, 0.4);
      border: 1px solid var(--treasure-bronze);
      border-radius: 8px;
      padding: 8px 12px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .reset-unit-btn {
      background: linear-gradient(145deg, #ff6b6b, #ff8e53);
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      margin-left: auto;
    }
    
    .reset-unit-btn:hover {
      background: linear-gradient(145deg, #ff8e53, #ff6b6b);
    }
    
    .pronunciation-btn {
      background: linear-gradient(145deg, #9c88ff, #6c5ce7);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .pronunciation-btn:hover {
      background: linear-gradient(145deg, #6c5ce7, #9c88ff);
      transform: translateY(-1px);
    }
    
    .pronunciation-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    @media (max-width: 480px) {
      .unit-grid {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 8px;
      }
      
      .unit-card {
        padding: 8px;
      }
      
      .unit-icon {
        font-size: 16px;
      }
      
      .unit-name {
        font-size: 11px;
      }
    }
    
    #compat-msg {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      border: 2px solid #ff4757;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
    }
    
    /* Shop Modal */
    .shop-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .shop-content {
      background: linear-gradient(145deg, #3d2914, #2a1a0a);
      border: 3px solid var(--treasure-gold);
      border-radius: 20px;
      width: min(90vw, 500px);
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--glow-gold);
    }

    .shop-header {
      background: linear-gradient(90deg, var(--treasure-gold), #ffed4a, var(--treasure-gold));
      color: #2d1b0a;
      padding: 15px 25px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      border-radius: 17px 17px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .shop-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #2d1b0a;
      padding: 0;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .shop-items {
      padding: 20px;
    }

    .shop-item {
      background: rgba(116, 88, 48, 0.3);
      border: 2px solid var(--treasure-bronze);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s ease;
    }

    .shop-item:hover {
      background: rgba(116, 88, 48, 0.5);
      border-color: var(--treasure-gold);
    }

    .shop-item-icon {
      font-size: 30px;
      width: 50px;
      text-align: center;
    }

    .shop-item-info {
      flex: 1;
    }

    .shop-item-name {
      font-size: 16px;
      font-weight: bold;
      color: var(--treasure-gold);
      margin-bottom: 5px;
    }

    .shop-item-desc {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .shop-item-price {
      font-size: 14px;
      color: var(--treasure-gold);
      font-weight: bold;
    }

    .shop-buy-btn {
      background: linear-gradient(145deg, var(--treasure-gold), #ffed4a);
      color: #2d1b0a;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .shop-buy-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .shop-buy-btn:disabled {
      background: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .inventory-info {
      background: rgba(74, 57, 25, 0.6);
      border: 1px solid var(--treasure-bronze);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .inventory-title {
      color: var(--treasure-gold);
      font-weight: bold;
      margin-bottom: 10px;
    }

    .owned-items {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .owned-item {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid var(--treasure-gold);
      border-radius: 8px;
      padding: 5px 10px;
      font-size: 12px;
    }

    @media (max-width: 480px) {
      .stats-bar {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        padding: 15px 20px;
      }
      .treasure-name { font-size: 28px; }
      .action-buttons { padding: 20px; }
      
      .shop-content {
        width: 95vw;
        margin: 10px;
      }
      
      .shop-item {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div id="compat-msg"></div>
  
  <div id="game-container">
    <div class="header">üè∫ Êë∏ÈáëËÉåÂçïËØçÂ§ßÂ∏à üè∫</div>
    
    <!-- Unit Selector -->
    <div class="unit-selector">
      <div class="unit-title">üìö ÈÄâÊã©Â≠¶‰π†ÂçïÂÖÉ</div>
      <div class="current-unit-display" id="current-unit-display">
        <span id="current-unit-info">üéØ ÂΩìÂâçÔºöÂÖ®ÈÉ®ÂçïÂÖÉÊ∑∑ÂêàÊ®°Âºè</span>
        <button class="reset-unit-btn" id="reset-unit-btn">ÈáçÁΩÆ</button>
      </div>
      <button class="unit-toggle" id="unit-toggle">Â±ïÂºÄÂçïÂÖÉÈÄâÊã©</button>
      <div class="unit-grid" id="unit-grid"></div>
    </div>
    
    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-icon">üí∞</span>
        <div class="stat-label">ÈáëÂ∏Å</div>
        <div class="stat-value" id="coins">500</div>
      </div>
      <div class="stat-item">
        <span class="stat-icon">‚ö°</span>
        <div class="stat-label">Á≠âÁ∫ß</div>
        <div class="stat-value" id="level">1</div>
      </div>
      <div class="stat-item">
        <span class="stat-icon">üíé</span>
        <div class="stat-label">ÂÆùÁâ©</div>
        <div class="stat-value" id="treasures">0</div>
      </div>
    </div>
    
    <div class="treasure-chamber">
      <div class="treasure-chest" id="treasure-chest"></div>
      
      <div class="treasure-info">
        <div class="treasure-name" id="treasure-name">Ancient Relic</div>
        <div class="treasure-phonetic" id="treasure-phonetic">/Ààe…™n É…ônt Ààr…õl…™k/</div>
        <div class="treasure-description" id="treasure-description">
          A mysterious artifact from ancient civilizations, waiting to be claimed by brave treasure hunters.
        </div>
        <div class="treasure-value" id="treasure-value">‰ª∑ÂÄº: 50ÈáëÂ∏Å</div>
        <button class="pronunciation-btn" id="pronunciation-btn">üîä Âê¨ÂèëÈü≥</button>
      </div>
    </div>
    
    <div class="action-buttons">
      <button class="treasure-btn speak-btn" id="speak-btn">
        üéôÔ∏è ËØ¥Âá∫ÂÆùÁâ©ÁúüÂêçÔºåËé∑ÂæóÂÆùËóè
      </button>
      
      <div class="manual-input">
        <input type="text" id="manual-input" placeholder="ÊàñËÄÖÂú®Ê≠§ËæìÂÖ•ÂÆùÁâ©ÁöÑËã±ÊñáÂêçÁß∞...">
        <button class="treasure-btn submit-btn" id="submit-btn">üîç Èâ¥ÂÆö</button>
      </div>
    </div>
    
    <div class="feedback" id="feedback">
      ÂáÜÂ§áÂ•Ω‰∫ÜÂêóÔºüËØ¥Âá∫ÂÆùÁâ©ÁöÑËã±ÊñáÂêçÁß∞Êù•Ëé∑ÂæóÂÆÉÂêßÔºÅ
    </div>
  </div>
  
  <button class="shop-btn" id="shop-btn" title="ÂÆùÁâ©ÂïÜÂ∫ó">üè™</button>

  <!-- Shop Modal -->
  <div class="shop-modal" id="shop-modal">
    <div class="shop-content">
      <div class="shop-header">
        <span>üè™ Á•ûÁßòÂÆùÁâ©ÂïÜÂ∫ó</span>
        <button class="shop-close" id="shop-close">√ó</button>
      </div>
      <div class="shop-items">
        <div class="inventory-info">
          <div class="inventory-title">üí∞ ÂΩìÂâçÈáëÂ∏Å: <span id="shop-coins">500</span></div>
          <div class="inventory-title">üéí Â∑≤Êã•ÊúâÈÅìÂÖ∑:</div>
          <div class="owned-items" id="owned-items">
            <span class="owned-item">ÊöÇÊó†ÈÅìÂÖ∑</span>
          </div>
        </div>
        <div id="shop-items-container"></div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- DOM Elements ---
      const ui = {
        coins: document.getElementById('coins'),
        level: document.getElementById('level'),
        treasures: document.getElementById('treasures'),
        treasureChest: document.getElementById('treasure-chest'),
        treasureName: document.getElementById('treasure-name'),
        treasurePhonetic: document.getElementById('treasure-phonetic'),
        treasureDescription: document.getElementById('treasure-description'),
        treasureValue: document.getElementById('treasure-value'),
        feedback: document.getElementById('feedback'),
        speakBtn: document.getElementById('speak-btn'),
        manualInput: document.getElementById('manual-input'),
        submitBtn: document.getElementById('submit-btn'),
        shopBtn: document.getElementById('shop-btn'),
        compatMsg: document.getElementById('compat-msg'),
        shopModal: document.getElementById('shop-modal'),
        shopClose: document.getElementById('shop-close'),
        shopCoins: document.getElementById('shop-coins'),
        ownedItems: document.getElementById('owned-items'),
        shopItemsContainer: document.getElementById('shop-items-container'),
        // Unit selector elements
        unitToggle: document.getElementById('unit-toggle'),
        unitGrid: document.getElementById('unit-grid'),
        currentUnitInfo: document.getElementById('current-unit-info'),
        resetUnitBtn: document.getElementById('reset-unit-btn'),
        pronunciationBtn: document.getElementById('pronunciation-btn'),
      };

      // --- Audio System ---
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      
      function playSound(type, frequency = 440, duration = 200) {
        if (!audioContext) return;
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        switch(type) {
          case 'success':
            // ÊàêÂäüÈü≥Êïà - ‰∏äÂçáÈü≥Ë∞É
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + duration / 1000);
            oscillator.type = 'sine';
            break;
          case 'error':
            // ÈîôËØØÈü≥Êïà - ‰∏ãÈôçÈü≥Ë∞É
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + duration / 1000);
            oscillator.type = 'sawtooth';
            break;
          case 'coin':
            // ÈáëÂ∏ÅÈü≥Êïà - Ê∏ÖËÑÜÈü≥Ë∞É
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
            oscillator.type = 'square';
            duration = 150;
            break;
          case 'click':
            // ÁÇπÂáªÈü≥Êïà - Áü≠‰øÉÈü≥Ë∞É
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
            oscillator.type = 'triangle';
            duration = 100;
            break;
          case 'level':
            // ÂçáÁ∫ßÈü≥Êïà - ‰∏âÈáçÈü≥Ë∞É
            playLevelUpSound();
            return;
        }
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration / 1000);
      }
      
      function playLevelUpSound() {
        // ÂçáÁ∫ßÈü≥Êïà - ‰∏â‰∏™Èü≥Á¨¶ÁªÑÊàêÁöÑÊóãÂæã
        const notes = [523, 659, 784]; // C5, E5, G5
        notes.forEach((freq, i) => {
          setTimeout(() => playSound('success', freq, 300), i * 200);
        });
      }

      // --- Game State ---
      const state = {
        coins: 500,
        level: 1,
        treasuresFound: 0,
        recognizing: false,
        currentTreasureIndex: 0,
        inventory: [],
        ownedItems: [],
        activeEffects: {
          goldMultiplier: 1,
          hintAvailable: false,
          expBoost: 1
        },
        // Unit system
        selectedUnit: null, // null = all units mixed
        unitProgress: {}, // track progress for each unit
        unitGridExpanded: false
      };

      // --- Shop Items ---
      const SHOP_ITEMS = [
        {
          id: 'gold_potion',
          name: 'üíé ÈªÑÈáëËçØÊ∞¥',
          desc: 'Êé•‰∏ãÊù•5‰∏™ÂÆùËóèÁöÑÈáëÂ∏ÅÂ•ñÂä±ÁøªÂÄç',
          price: 300,
          icon: 'üíé',
          effect: 'gold_boost',
          uses: 5
        },
        {
          id: 'hint_crystal',
          name: 'üîÆ ÊèêÁ§∫Ê∞¥Êô∂',
          desc: 'ÂèØ‰ª•Êü•ÁúãÂΩìÂâçÂÆùÁâ©ÁöÑÈ¶ñÂ≠óÊØçÊèêÁ§∫',
          price: 150,
          icon: 'üîÆ',
          effect: 'hint',
          uses: 3
        },
        {
          id: 'exp_amulet',
          name: '‚ö° ÁªèÈ™åÊä§Á¨¶',
          desc: 'ÂçáÁ∫ßÊâÄÈúÄÂÆùÁâ©Êï∞ÈáèÂáèÂ∞ë1‰∏™ÔºàÊ∞∏‰πÖÔºâ',
          price: 500,
          icon: '‚ö°',
          effect: 'exp_boost',
          uses: 1,
          permanent: true
        },
        {
          id: 'luck_charm',
          name: 'üçÄ Âπ∏ËøêÁ¨¶Âíí',
          desc: 'ÂèëÈü≥ÈîôËØØÊó∂Êúâ50%Âá†Áéá‰∏çÊâ£ÈáëÂ∏Å',
          price: 200,
          icon: 'üçÄ',
          effect: 'luck',
          uses: 10
        },
        {
          id: 'voice_enhancer',
          name: 'üéôÔ∏è ËØ≠Èü≥Â¢ûÂº∫Âô®',
          desc: 'ÊèêÈ´òËØ≠Èü≥ËØÜÂà´ÂáÜÁ°ÆÂ∫¶ÔºàÈôç‰ΩéËØÜÂà´Èó®ÊßõÔºâ',
          price: 400,
          icon: 'üéôÔ∏è',
          effect: 'voice_boost',
          uses: 1,
          permanent: true
        }
      ];

      // --- ÊåâÂçïÂÖÉÁªÑÁªáÁöÑÂçïËØçÂ∫ì (‰∫∫ÊïôÁâà7Âπ¥Á∫ß‰∏äÂÜå) ---
      const UNIT_TREASURES = {
        unit1: {
          name: "Unit 1 - ÂàùÊ¨°Áõ∏ÈÅá",
          icon: "üëã",
          words: [
            { name: 'name', ipa: '/ne…™m/', desc: 'ËÆ∞ÂΩïË∫´‰ªΩÁöÑÁ•ûÁßòÁ¨¶Êñá', value: 20, icon: 'üìõ' },
            { name: 'nice', ipa: '/na…™s/', desc: 'Â∏¶Êù•ÊÑâÊÇ¶ÁöÑÊ∏©ÊöñÂÆùÁü≥', value: 25, icon: 'üòä' },
            { name: 'meet', ipa: '/miÀêt/', desc: 'ËøûÊé•ÂøÉÁÅµÁöÑÊ°•Ê¢Å', value: 25, icon: 'ü§ù' },
            { name: 'hello', ipa: '/h…ôÀàlo ä/', desc: 'ÂºÄÂêØÂèãË∞äÂ§ßÈó®ÁöÑÈ≠îÊ≥ïÂííËØ≠', value: 20, icon: 'üëã' },
            { name: 'hi', ipa: '/ha…™/', desc: 'ÁÆÄÂçïÂç¥Ê∏©ÊöñÁöÑÈóÆÂÄô‰πãÂÖâ', value: 15, icon: 'üåü' },
            { name: 'good', ipa: '/…° äd/', desc: 'Ëï¥Âê´ÂñÑËâØÂäõÈáèÁöÑÂè§ËÄÅËØçÊ±á', value: 25, icon: '‚ú®' },
            { name: 'morning', ipa: '/Ààm…îÀêrn…™≈ã/', desc: 'ÊõôÂÖâÂàùÁé∞ÁöÑÂ∏åÊúõÊó∂Âàª', value: 40, icon: 'üåÖ' },
            { name: 'afternoon', ipa: '/Àå√¶ft…ôrÀànuÀên/', desc: 'Èò≥ÂÖâÊ≠£ÁõõÁöÑÊ¥ªÂäõÊó∂ÂÖâ', value: 50, icon: '‚òÄÔ∏è' },
            { name: 'evening', ipa: '/ÀàiÀêvn…™≈ã/', desc: 'Â§ïÈò≥Ë•ø‰∏ãÁöÑÂÆÅÈùôÊó∂ÂàÜ', value: 45, icon: 'üåÜ' },
            { name: 'thanks', ipa: '/Œ∏√¶≈ãks/', desc: 'ÊÑüÊÅ©‰πãÂøÉÁöÑÁæéÂ•ΩÂõûÂìç', value: 35, icon: 'üôè' },
            { name: 'fine', ipa: '/fa…™n/', desc: 'ÂÆåÁæéÁä∂ÊÄÅÁöÑÂÖâÊòéÂç∞ËÆ∞', value: 25, icon: 'üëå' },
            { name: 'ok', ipa: '/Àåo äÀàke…™/', desc: 'Á°ÆËÆ§ÂêåÊÑèÁöÑÁÆÄÊ¥ÅÁ¨¶Âè∑', value: 15, icon: '‚úÖ' }
          ]
        },
        unit2: {
          name: "Unit 2 - ÂÆ∂Â∫≠ÊàêÂëò",
          icon: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
          words: [
            { name: 'family', ipa: '/Ààf√¶m…ôli/', desc: 'Ë°ÄËÑâÁõ∏ËøûÁöÑÊ∏©ÊöñÊ∏ØÊπæ', value: 35, icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
            { name: 'father', ipa: '/Ààf…ëÀê√∞…ôr/', desc: 'Â¶ÇÂ±±Ëà¨ÂùöÂÆûÁöÑÂÆàÊä§ËÄÖ', value: 35, icon: 'üë®' },
            { name: 'mother', ipa: '/Ààm å√∞…ôr/', desc: 'Â¶ÇÊµ∑Ëà¨Ê∑±ÊÉÖÁöÑÂëµÊä§ËÄÖ', value: 35, icon: 'üë©' },
            { name: 'parents', ipa: '/Ààper…ônts/', desc: 'ÁîüÂëΩËµ∑Ê∫êÁöÑÂàõÈÄ†ËÄÖ‰ª¨', value: 40, icon: 'üë®‚Äçüë©' },
            { name: 'sister', ipa: '/Ààs…™st…ôr/', desc: 'ÂøÉÁÅµÁõ∏ÈÄöÁöÑÁé´Áë∞Ëä±', value: 35, icon: 'üë≠' },
            { name: 'brother', ipa: '/Ààbr å√∞…ôr/', desc: 'Âπ∂ËÇ©‰ΩúÊàòÁöÑÊàòÂèã', value: 40, icon: 'üë¨' },
            { name: 'grandfather', ipa: '/Àà…°r√¶nf…ëÀê√∞…ôr/', desc: 'Êô∫ÊÖßÈïøËÄÖÁöÑÊÖàÁ••ÂÖâËæâ', value: 60, icon: 'üë¥' },
            { name: 'grandmother', ipa: '/Àà…°r√¶nm å√∞…ôr/', desc: 'Ê∏©ÊöñÊÄÄÊä±ÁöÑÊÖàÁà±ÈïøËæà', value: 65, icon: 'üëµ' },
            { name: 'uncle', ipa: '/Àà å≈ãk…ôl/', desc: '‰∫≤ÊÉÖÁ∫ΩÂ∏¶ÁöÑÂèØÈù†ÊîØÊü±', value: 30, icon: 'üë®‚Äçü¶≤' },
            { name: 'aunt', ipa: '/√¶nt/', desc: 'Ê∏©ÊüîÂÖ≥ÊÄÄÁöÑÈïøËæàÊòéÁè†', value: 25, icon: 'üë©‚Äçü¶≥' },
            { name: 'cousin', ipa: '/Ààk åz…ôn/', desc: 'Á´•Âπ¥Áé©‰º¥ÁöÑ‰∫≤ÊÉÖÁ∫ΩÂ∏¶', value: 35, icon: 'üë´' },
            { name: 'friend', ipa: '/frend/', desc: 'ÊÇ£Èöæ‰∏éÂÖ±ÁöÑÁèçË¥µÂÆùËóè', value: 35, icon: 'üë´' }
          ]
        },
        unit3: {
          name: "Unit 3 - Á•ûÂ•áÊï∞Â≠ó",
          icon: "üî¢",
          words: [
            { name: 'zero', ipa: '/Ààz…™ro ä/', desc: '‰∏áÁâ©Ëµ∑Ê∫êÁöÑÁ©∫Êó†‰πãÊï∞', value: 25, icon: '0Ô∏è‚É£' },
            { name: 'one', ipa: '/w ån/', desc: 'Áã¨‰∏ÄÊó†‰∫åÁöÑÂäõÈáèÊ∫êÊ≥â', value: 20, icon: '1Ô∏è‚É£' },
            { name: 'two', ipa: '/tuÀê/', desc: 'Âπ≥Ë°°ÂÆáÂÆôÁöÑÂèåÂ≠êÂäõÈáè', value: 20, icon: '2Ô∏è‚É£' },
            { name: 'three', ipa: '/Œ∏riÀê/', desc: '‰∏âÁîü‰∏áÁâ©ÁöÑÁ•ûÁßòÊï∞Â≠ó', value: 25, icon: '3Ô∏è‚É£' },
            { name: 'four', ipa: '/f…îÀêr/', desc: 'ÂõõÊñπÂÆàÊä§ÁöÑÁ®≥Âõ∫Âü∫Áü≥', value: 25, icon: '4Ô∏è‚É£' },
            { name: 'five', ipa: '/fa…™v/', desc: '‰∫îË°åÁõ∏ÁîüÁöÑÂÖÉÁ¥†‰πãÂäõ', value: 25, icon: '5Ô∏è‚É£' },
            { name: 'six', ipa: '/s…™ks/', desc: 'ÂÖ≠Âêà‰πãÂÜÖÁöÑÊó†ÈôêÂèØËÉΩ', value: 20, icon: '6Ô∏è‚É£' },
            { name: 'seven', ipa: '/Ààsev…ôn/', desc: '‰∏ÉÊòüËøûÁè†ÁöÑÂπ∏ËøêÊï∞Â≠ó', value: 30, icon: '7Ô∏è‚É£' },
            { name: 'eight', ipa: '/e…™t/', desc: 'ÂÖ´Âç¶Âæ™ÁéØÁöÑÊ∞∏ÊÅíÂØÜÁ†Å', value: 30, icon: '8Ô∏è‚É£' },
            { name: 'nine', ipa: '/na…™n/', desc: '‰πùÈáçÂ§©Â§ñÁöÑËá≥È´òÂäõÈáè', value: 25, icon: '9Ô∏è‚É£' },
            { name: 'ten', ipa: '/ten/', desc: 'ÂçÅÂÖ®ÂçÅÁæéÁöÑÂúÜÊª°‰πãÊï∞', value: 20, icon: 'üîü' },
            { name: 'phone', ipa: '/fo än/', desc: '‰º†ÈÄíÂçÉÈáåÈü≥‰ø°ÁöÑÁ•ûÂô®', value: 30, icon: 'üìû' },
            { name: 'number', ipa: '/Ààn åmb…ôr/', desc: 'ÂÆáÂÆôÂØÜÁ†ÅÁöÑÊï∞Â≠óÂ••Áßò', value: 35, icon: 'üî¢' },
            { name: 'card', ipa: '/k…ëÀêrd/', desc: 'ËÆ∞ÂΩïÈáçË¶Å‰ø°ÊÅØÁöÑÈ≠îÊ≥ïÂç°Áâá', value: 25, icon: 'üÉè' }
          ]
        },
        unit4: {
          name: "Unit 4 - Áº§Á∫∑Ëâ≤ÂΩ©",
          icon: "üé®",
          words: [
            { name: 'color', ipa: '/Ààk ål…ôr/', desc: '‰∏∫‰∏ñÁïåÊüìËâ≤ÁöÑÁ•ûÂ•áÁîªÁ¨î', value: 30, icon: 'üé®' },
            { name: 'red', ipa: '/red/', desc: 'Â¶ÇÁÅ´ÁÑ∞Ëà¨ÁÇΩÁÉ≠ÁöÑÊøÄÊÉÖ', value: 20, icon: 'üî¥' },
            { name: 'yellow', ipa: '/Ààjelo ä/', desc: 'Èò≥ÂÖâËà¨Ê∏©ÊöñÁöÑÂÖâËäí', value: 35, icon: 'üü°' },
            { name: 'green', ipa: '/…°riÀên/', desc: 'ÁîüÊú∫ÂãÉÂãÉÁöÑËá™ÁÑ∂‰πãÂäõ', value: 30, icon: 'üü¢' },
            { name: 'blue', ipa: '/bluÀê/', desc: 'Ê∑±ÈÇÉÂ¶ÇÊµ∑ÁöÑÂÆÅÈùô‰πãÊ∫ê', value: 25, icon: 'üîµ' },
            { name: 'black', ipa: '/bl√¶k/', desc: 'Á•ûÁßòÂ§úÁ©∫ÁöÑÊó†Â∞ΩÊ∑±Â∫¶', value: 30, icon: '‚ö´' },
            { name: 'white', ipa: '/wa…™t/', desc: 'Á∫ØÊ¥ÅÂ¶ÇÈõ™ÁöÑÂÖâÊòé‰πãÂøÉ', value: 30, icon: '‚ö™' },
            { name: 'purple', ipa: '/Ààp…úÀêrp…ôl/', desc: 'È´òË¥µÂÖ∏ÈõÖÁöÑÁöáÂÆ§Ëâ≤ÂΩ©', value: 35, icon: 'üü£' },
            { name: 'brown', ipa: '/bra än/', desc: 'Â§ßÂú∞ÊØç‰∫≤ÁöÑÊ∏©ÊöñÊÄÄÊä±', value: 30, icon: 'üü§' },
            { name: 'orange', ipa: '/Àà…îÀêr…™nd í/', desc: 'ÁßãÊó•Â§ïÈò≥ÁöÑÊ∏©ÊüîÂÖâËæâ', value: 35, icon: 'üü†' },
            { name: 'pink', ipa: '/p…™≈ãk/', desc: 'Â∞ëÂ•≥ÂøÉ‰∏≠ÁöÑÊµ™Êº´Ê¢¶ÊÉ≥', value: 25, icon: 'ü©∑' },
            { name: 'gray', ipa: '/…°re…™/', desc: '‰∫ëÈõæÁº≠ÁªïÁöÑ‰∏≠ÊÄß‰πãÁæé', value: 25, icon: 'ü©∂' }
          ]
        },
        unit5: {
          name: "Unit 5 - Ê±ÇÂ≠¶‰πãË∑Ø",
          icon: "üéì",
          words: [
            { name: 'school', ipa: '/skuÀêl/', desc: 'Êô∫ÊÖß‰º†ÊâøÁöÑÁ•ûÂú£ÊÆøÂ†Ç', value: 60, icon: 'üè´' },
            { name: 'teacher', ipa: '/ÀàtiÀêt É…ôr/', desc: 'ÁÇπ‰∫ÆÂøÉÁÅµÁöÑÁü•ËØÜÊòéÁÅØ', value: 70, icon: 'üë®‚Äçüè´' },
            { name: 'student', ipa: '/ÀàstuÀêd…ônt/', desc: 'Ê∏¥ÊúõÁü•ËØÜÁöÑÊ±ÇÁ¥¢ËÄÖ', value: 75, icon: 'üë®‚Äçüéì' },
            { name: 'classroom', ipa: '/Ààkl√¶sruÀêm/', desc: 'Áü•ËØÜËä±Âõ≠ÁöÑÂüπËÇ≤Ê∏©ÂÆ§', value: 85, icon: 'üèõÔ∏è' },
            { name: 'subject', ipa: '/Ààs åbd í…™kt/', desc: 'Â≠¶ÈóÆÊµ∑Ê¥ãÁöÑ‰∏ÄÂè∂ÊâÅËàü', value: 75, icon: 'üìö' },
            { name: 'lesson', ipa: '/Ààles…ôn/', desc: 'Êô∫ÊÖß‰º†ÊéàÁöÑÁèçË¥µÊó∂ÂÖâ', value: 35, icon: 'üìñ' },
            { name: 'chinese', ipa: '/Àåt Éa…™ÀàniÀêz/', desc: '‰∫îÂçÉÂπ¥ÊñáÊòéÁöÑËØ≠Ë®ÄÁë∞ÂÆù', value: 80, icon: 'üÄÑ' },
            { name: 'english', ipa: '/Àà…™≈ã…°l…™ É/', desc: 'ËøûÊé•‰∏ñÁïåÁöÑËØ≠Ë®ÄÊ°•Ê¢Å', value: 80, icon: 'üá¨üáß' },
            { name: 'math', ipa: '/m√¶Œ∏/', desc: 'ÈÄªËæëÊÄùÁª¥ÁöÑÊï∞Â≠óÁéãÂõΩ', value: 25, icon: 'üî¢' },
            { name: 'history', ipa: '/Ààh…™st…ôri/', desc: 'Êó∂Èó¥ÈïøÊ≤≥ÁöÑËÆ∞ÂøÜÂÆùÂ∫ì', value: 85, icon: 'üìú' },
            { name: 'geography', ipa: '/d íiÀà…ëÀê…°r…ôfi/', desc: 'Êé¢Á¥¢Â§ßÂú∞Â••ÁßòÁöÑÊåáÂçóÈíà', value: 95, icon: 'üó∫Ô∏è' },
            { name: 'science', ipa: '/Ààsa…™…ôns/', desc: 'Ëß£ÂºÄÂÆáÂÆôÂØÜÁ†ÅÁöÑÈí•Âåô', value: 85, icon: 'üî¨' }
          ]
        },
        unit6: {
          name: "Unit 6 - Êó∂ÂÖâÂç∞ËÆ∞",
          icon: "üóìÔ∏è",
          words: [
            { name: 'birthday', ipa: '/Ààb…úÀêrŒ∏de…™/', desc: 'ÁîüÂëΩËØûÁîüÁöÑÁ∫™ÂøµÂú£Êó•', value: 85, icon: 'üéÇ' },
            { name: 'january', ipa: '/Ààd í√¶njueri/', desc: 'Êñ∞Âπ¥‰ºäÂßãÁöÑÂ∏åÊúõ‰πãÊúà', value: 90, icon: 'üìÖ' },
            { name: 'february', ipa: '/Ààfebrueri/', desc: 'Áà±ÊÑèÁªµÁªµÁöÑÊµ™Êº´‰πãÊúà', value: 95, icon: 'üíù' },
            { name: 'march', ipa: '/m…ëÀêrt É/', desc: '‰∏áÁâ©Â§çËãèÁöÑÊò•Â§©Â∫èÊõ≤', value: 30, icon: 'üå∏' },
            { name: 'april', ipa: '/Ààe…™pr…ôl/', desc: 'Êò•Ëä±ÁÉÇÊº´ÁöÑÁæéÂ•ΩÊó∂ÂÖâ', value: 30, icon: 'üå∑' },
            { name: 'may', ipa: '/me…™/', desc: 'ÈùíÊò•Ê¥ãÊ∫¢ÁöÑÊ¥ªÂäõ‰πãÊúà', value: 20, icon: 'üå∫' },
            { name: 'june', ipa: '/d íuÀên/', desc: 'Â§èÊó•ÁÇéÁÇéÁöÑÊøÄÊÉÖÂ≤ÅÊúà', value: 25, icon: '‚òÄÔ∏è' },
            { name: 'july', ipa: '/d íuÀàla…™/', desc: 'È™ÑÈò≥‰ººÁÅ´ÁöÑÁÉ≠ÊÉÖ‰πãÊúà', value: 25, icon: 'üèñÔ∏è' },
            { name: 'august', ipa: '/Àà…îÀê…°…ôst/', desc: 'ÁßãÊÑèÊ∏êÊµìÁöÑÊî∂Ëé∑ÂâçÂ•è', value: 35, icon: 'üåæ' },
            { name: 'september', ipa: '/sepÀàtemb…ôr/', desc: 'ÈáëÁßãÈÄÅÁàΩÁöÑ‰∏∞Êî∂‰πãÊúà', value: 50, icon: 'üçÅ' },
            { name: 'october', ipa: '/…ëÀêkÀàto äb…ôr/', desc: 'ÈáëÊ°ÇÈ£òÈ¶ôÁöÑÊî∂Ëé∑Â≠£ËäÇ', value: 90, icon: 'üçÇ' },
            { name: 'november', ipa: '/no äÀàvemb…ôr/', desc: 'ÊÑüÊÅ©ÂõûÈ¶àÁöÑÊ∏©Êöñ‰πãÊúà', value: 95, icon: 'ü¶É' },
            { name: 'december', ipa: '/d…™Ààsemb…ôr/', desc: 'Âπ¥ÁªàÂ≤ÅÊú´ÁöÑÁ•àÊÑø‰πãÊúà', value: 90, icon: 'üéÑ' }
          ]
        },
        unit7: {
          name: "Unit 7 - ÂçéÁæéË°£Ë£Ö",
          icon: "üëó",
          words: [
            { name: 'clothes', ipa: '/klo ä√∞z/', desc: 'ÂåÖË£πË∫´‰ΩìÁöÑÂçéÁæéÂ§ñË°£', value: 75, icon: 'üëó' },
            { name: 'trousers', ipa: '/Ààtra äz…ôrz/', desc: 'ÂèåËÖøÊä§Áî≤ÁöÑÂÆûÁî®ÊàòË¢ç', value: 85, icon: 'üëñ' },
            { name: 'sweater', ipa: '/Ààswet…ôr/', desc: 'Ê∏©ÊöñÂ¶ÇÊò•ÁöÑÁºñÁªáÊã•Êä±', value: 80, icon: 'üß•' },
            { name: 'shirt', ipa: '/ É…úÀêrt/', desc: '‰ºòÈõÖË∫´ÂßøÁöÑË¥¥Ë∫´‰ºô‰º¥', value: 30, icon: 'üëî' },
            { name: 'shoes', ipa: '/ ÉuÀêz/', desc: 'Ë∂≥‰∏ãÁîüÈ£éÁöÑË°åËµ∞‰ºô‰º¥', value: 30, icon: 'üëû' },
            { name: 'socks', ipa: '/s…ëÀêks/', desc: 'Ë∂≥ÈÉ®Ê∏©ÊöñÁöÑÊüîËΩØÂÆàÊä§', value: 25, icon: 'üß¶' },
            { name: 'hat', ipa: '/h√¶t/', desc: 'Â§¥È°∂È£éÈááÁöÑÊó∂Â∞öË£ÖÈ•∞', value: 20, icon: 'üëí' },
            { name: 'jacket', ipa: '/Ààd í√¶k…™t/', desc: 'Â§ñÂá∫ÂøÖÂ§áÁöÑ‰øùÊä§Èì†Áî≤', value: 35, icon: 'üß•' },
            { name: 'dress', ipa: '/dres/', desc: '‰ºòÈõÖÂ•≥ÊÄßÁöÑÁæé‰∏ΩË±°ÂæÅ', value: 30, icon: 'üëó' },
            { name: 'skirt', ipa: '/sk…úÀêrt/', desc: 'È£òÈÄ∏Â¶ÇËä±ÁöÑÂ•≥ÊÄß‰∏ìÂ±û', value: 30, icon: 'üëó' }
          ]
        },
        unit8: {
          name: "Unit 8 - È£üÁâ©ÁõõÂÆ¥",
          icon: "üçΩÔ∏è",
          words: [
            { name: 'food', ipa: '/fuÀêd/', desc: 'Áª¥ÊåÅÁîüÂëΩÁöÑÁèçË¥µÂÖªÊñô', value: 25, icon: 'üçΩÔ∏è' },
            { name: 'breakfast', ipa: '/Ààbrekf…ôst/', desc: 'ÂºÄÂêØ‰∏ÄÂ§©ÁöÑËÉΩÈáèÊ∫êÊ≥â', value: 50, icon: 'ü•ê' },
            { name: 'lunch', ipa: '/l ånt É/', desc: 'ÂçàÈó¥Ë°•ÁªôÁöÑËê•ÂÖªÁõõÂÆ¥', value: 30, icon: 'üç±' },
            { name: 'dinner', ipa: '/Ààd…™n…ôr/', desc: 'Â§úÂπïÈôç‰∏¥ÁöÑ‰∏∞ÁõõËÅöÈ§ê', value: 35, icon: 'üçΩÔ∏è' },
            { name: 'apple', ipa: '/Àà√¶p…ôl/', desc: 'Êô∫ÊÖßÊûúÂõ≠ÁöÑÁîúÁæéËØ±ÊÉë', value: 25, icon: 'üçé' },
            { name: 'banana', ipa: '/b…ôÀàn√¶n…ô/', desc: 'ÁÉ≠Â∏¶Èò≥ÂÖâÁöÑÈªÑÈáëÊûúÂÆû', value: 35, icon: 'üçå' },
            { name: 'orange', ipa: '/Àà…îÀêr…™nd í/', desc: 'Áª¥C‰∏∞ÂØåÁöÑÊ©ôËâ≤Á≤æÁÅµ', value: 35, icon: 'üçä' },
            { name: 'milk', ipa: '/m…™lk/', desc: 'Á∫ØÁôΩÂ¶ÇÈõ™ÁöÑËê•ÂÖªÁîòÈú≤', value: 25, icon: 'ü•õ' },
            { name: 'bread', ipa: '/bred/', desc: 'È∫¶È¶ôÊµìÈÉÅÁöÑÁîüÊ¥ª‰∏ªÈ£ü', value: 30, icon: 'üçû' },
            { name: 'chicken', ipa: '/Ààt É…™k…™n/', desc: 'ËõãÁôΩË¥®‰∏∞ÂØåÁöÑÁæéÂë≥ÁèçÂìÅ', value: 40, icon: 'üçó' },
            { name: 'rice', ipa: '/ra…™s/', desc: '‰∏úÊñπÊñáÊòéÁöÑ‰∏ªÈ£üÁë∞ÂÆù', value: 25, icon: 'üçö' },
            { name: 'water', ipa: '/Ààw…îÀêt…ôr/', desc: 'ÁîüÂëΩ‰πãÊ∫êÁöÑÁ∫ØÂáÄÊ∂≤‰Ωì', value: 20, icon: 'üíß' }
          ]
        },
        unit9: {
          name: "Unit 9 - ÊòüÊúüËΩÆÂõû",
          icon: "üìÖ",
          words: [
            { name: 'monday', ipa: '/Ààm ånde…™/', desc: 'Êñ∞Âë®ÂºÄÂßãÁöÑÂ•ãÊñó‰πãÊó•', value: 35, icon: 'üìÖ' },
            { name: 'tuesday', ipa: '/ÀàtuÀêzde…™/', desc: 'ÊàòÁ•ûÊä§‰ΩëÁöÑÂãáÁåõ‰πãÊó•', value: 40, icon: '‚öîÔ∏è' },
            { name: 'wednesday', ipa: '/Ààwenzde…™/', desc: 'Êô∫ÊÖß‰πãÁ•ûÁöÑÂêØÁ§∫‰πãÊó•', value: 50, icon: 'üß†' },
            { name: 'thursday', ipa: '/ÀàŒ∏…úÀêrzde…™/', desc: 'Èõ∑Á•û‰πãÈî§ÁöÑÂäõÈáè‰πãÊó•', value: 45, icon: '‚ö°' },
            { name: 'friday', ipa: '/Ààfra…™de…™/', desc: 'Áà±Á•ûÁú∑È°æÁöÑÊµ™Êº´‰πãÊó•', value: 35, icon: 'üíñ' },
            { name: 'saturday', ipa: '/Ààs√¶t…ôrde…™/', desc: 'ÂÜúÁ•ûËµêÁ¶èÁöÑ‰∏∞Êî∂‰πãÊó•', value: 50, icon: 'üåæ' },
            { name: 'sunday', ipa: '/Ààs ånde…™/', desc: 'Â§™Èò≥Á•ûÁÖßËÄÄÁöÑÂÖâÊòé‰πãÊó•', value: 35, icon: '‚òÄÔ∏è' },
            { name: 'today', ipa: '/t…ôÀàde…™/', desc: 'ÂΩì‰∏ãÊ≠§ÂàªÁöÑÁèçË¥µÊó∂ÂÖâ', value: 30, icon: 'üìç' },
            { name: 'tomorrow', ipa: '/t…ôÀàm…ëÀêro ä/', desc: 'ÂÖÖÊª°Â∏åÊúõÁöÑÊú™Êù•‰πãÊó•', value: 45, icon: 'üåÖ' },
            { name: 'yesterday', ipa: '/Ààjest…ôrde…™/', desc: 'Â∑≤ÊàêÂõûÂøÜÁöÑÊò®Êó•Êó∂ÂÖâ', value: 50, icon: 'üì∏' },
            { name: 'weekend', ipa: '/ÀåwiÀêkÀàend/', desc: 'ÊîæÊùæË∫´ÂøÉÁöÑ‰ºëÊÅØÊó∂ÂÖâ', value: 40, icon: 'üèñÔ∏è' }
          ]
        }
      };

      // ÁîüÊàêÂÖºÂÆπÁöÑÈöæÂ∫¶ÂàÜÁ∫ßÁ≥ªÁªü (‰øùÊåÅÂêëÂêéÂÖºÂÆπ)
      const TREASURES = {
        bronze: [],
        silver: [],
        gold: [
          { name: 'mysterious', ipa: '/m…™Ààst…™…ôri…ôs/', desc: 'ÂÖÖÊª°Êú™Áü•È≠îÂäõÁöÑÁ•ûÁßòÁâ©ÂìÅ', value: 200, icon: 'üé≠' },
          { name: 'magnificent', ipa: '/m√¶gÀàn…™f…ôs…ônt/', desc: '‰ª§‰∫∫Âèπ‰∏∫ËßÇÊ≠¢ÁöÑÂçé‰∏ΩÂÆùÁâ©', value: 250, icon: 'üëë' },
          { name: 'extraordinary', ipa: '/…™kÀàstr…îÀêrd…ôÀån…õri/', desc: 'Ë∂ÖË∂äÂá°‰øóÁöÑÈùûÂá°Âú£Âô®', value: 300, icon: '‚ú®' },
          { name: 'archaeological', ipa: '/Àå…ëÀêrki…ôÀàl…íd í…™k…ôl/', desc: 'ËÄÉÂè§Â≠¶ÂÆ∂Ê¢¶ÂØê‰ª•Ê±ÇÁöÑÊñáÁâ©', value: 350, icon: 'üèõÔ∏è' },
          { name: 'philosopher', ipa: '/f…ôÀàl…ís…ôf…ôr/', desc: 'Âì≤Â≠¶ÂÆ∂ÁöÑË¥§ËÄÖ‰πãÁü≥', value: 280, icon: 'üíé' }
        ],
        diamond: [
          { name: 'incomprehensible', ipa: '/Àå…™nk…ímpr…™Ààh…õns…ôb…ôl/', desc: 'Ë∂ÖË∂ä‰∫∫Á±ªÁêÜËß£ÁöÑÁªàÊûÅÁ•ûÂô®', value: 500, icon: 'üåü' },
          { name: 'transcendental', ipa: '/Àåtr√¶ns…õnÀàd…õnt…ôl/', desc: 'Ë∂ÖË∂äÁâ©Ë¥®‰∏ñÁïåÁöÑÁ≤æÁ•ûÂÆùËóè', value: 600, icon: 'üî±' },
          { name: 'metamorphosis', ipa: '/Àåm…õt…ôÀàm…îÀêrf…ôs…™s/', desc: 'ËÉΩÂ§üÊîπÂèò‰∏ÄÂàáÁöÑÂèòÂΩ¢Ê≥ïÂô®', value: 550, icon: 'ü¶ã' },
          { name: 'philosophical', ipa: '/Àåf…™l…ôÀàs…íf…™k…ôl/', desc: 'ÂåÖÂê´ÂÆáÂÆôÁúüÁêÜÁöÑÊô∫ÊÖßÁªìÊô∂', value: 650, icon: 'üßø' },
          { name: 'pronunciation', ipa: '/pr…ôÀån ånsiÀàe…™ É…ôn/', desc: 'ÊéåÊéßËØ≠Ë®ÄÈ≠îÊ≥ïÁöÑÂèëÈü≥ÂÆùÂÖ∏', value: 700, icon: 'üìñ' }
        ]
      };

      // ÂàùÂßãÂåñÂÖºÂÆπÊÄßÊï∞ÊçÆ - Â∞ÜÂçïÂÖÉÂçïËØçÊåâ‰ª∑ÂÄºÂàÜÈÖçÂà∞‰∏çÂêåÈöæÂ∫¶
      function initializeTreasures() {
        // Clear existing arrays
        TREASURES.bronze = [];
        TREASURES.silver = [];
        
        // Distribute words from units by value ranges
        Object.values(UNIT_TREASURES).forEach(unitData => {
          unitData.words.forEach(word => {
            if (word.value <= 40) {
              TREASURES.bronze.push(word);
            } else if (word.value <= 100) {
              TREASURES.silver.push(word);
            }
            // Keep gold and diamond as advanced words
          });
        });
      }

      // Ëé∑ÂèñÂΩìÂâçÈöæÂ∫¶Á≠âÁ∫ßÁöÑÂÆùÁâ© (‰ªÖÁî®‰∫éÂêëÂêéÂÖºÂÆπ)
      function getCurrentTreasureLevel() {
        if (state.level <= 5) return 'bronze';
        if (state.level <= 10) return 'silver';
        if (state.level <= 15) return 'gold';
        return 'diamond';
      }

      // --- Speech Recognition Setup ---
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      let recognizer = null;
      let permissionGranted = false;
      
      if (SpeechRecognition && navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(() => {
            permissionGranted = true;
            ui.feedback.textContent = 'üéôÔ∏è È∫¶ÂÖãÈ£éÊùÉÈôêÂ∑≤Ëé∑ÂèñÔºåÂºÄÂßã‰Ω†ÁöÑÂØªÂÆù‰πãÊóÖÔºÅ';
          })
          .catch(() => {
            ui.compatMsg.textContent = 'üö´ ÈúÄË¶ÅÈ∫¶ÂÖãÈ£éÊùÉÈôêÊâçËÉΩËøõË°åËØ≠Èü≥ËØÜÂà´ÂØªÂÆù';
            ui.compatMsg.style.display = 'block';
          });
      }

      if (SpeechRecognition) {
        recognizer = new SpeechRecognition();
        recognizer.lang = 'en-US';
        recognizer.continuous = false;
        recognizer.interimResults = false;

        recognizer.onstart = () => {
          state.recognizing = true;
          ui.speakBtn.textContent = 'üéØ Ê≠£Âú®ËØÜÂà´È≠îÂíí...';
          ui.speakBtn.disabled = true;
          ui.feedback.textContent = 'üì¢ Â§ßÂ£∞ËØ¥Âá∫ÂÆùÁâ©ÁöÑËã±ÊñáÂêçÁß∞...';
          ui.feedback.className = 'feedback';
        };

        recognizer.onresult = (event) => {
          const spokenText = event.results[0][0].transcript;
          checkTreasureName(spokenText);
        };

        recognizer.onerror = (event) => {
          ui.feedback.textContent = `üí• È≠îÂííËØÜÂà´Â§±Ë¥•: ${event.error}`;
          ui.feedback.className = 'feedback error';
        };

        recognizer.onend = () => {
          state.recognizing = false;
          ui.speakBtn.textContent = 'üéôÔ∏è ËØ¥Âá∫ÂÆùÁâ©ÁúüÂêçÔºåËé∑ÂæóÂÆùËóè';
          ui.speakBtn.disabled = false;
        };
      } else {
        ui.compatMsg.textContent = '‚ö†Ô∏è ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´ÔºåËØ∑‰ΩøÁî®ÊâãÂä®ËæìÂÖ•';
        ui.compatMsg.style.display = 'block';
        ui.speakBtn.style.display = 'none';
      }

      // --- Shop Functions ---
      function renderShop() {
        ui.shopCoins.textContent = state.coins;
        
        // Ê∏≤ÊüìÊã•ÊúâÁöÑÈÅìÂÖ∑
        if (state.ownedItems.length === 0) {
          ui.ownedItems.innerHTML = '<span class="owned-item">ÊöÇÊó†ÈÅìÂÖ∑</span>';
        } else {
          ui.ownedItems.innerHTML = state.ownedItems
            .map(item => `<span class="owned-item">${item.icon} ${item.name} (${item.uses > 0 ? item.uses + 'Ê¨°' : 'Ê∞∏‰πÖ'})</span>`)
            .join('');
        }
        
        // Ê∏≤ÊüìÂïÜÂìÅ
        ui.shopItemsContainer.innerHTML = SHOP_ITEMS.map(item => {
          const canAfford = state.coins >= item.price;
          const alreadyOwned = state.ownedItems.some(owned => owned.id === item.id && owned.permanent);
          
          return `
            <div class="shop-item">
              <div class="shop-item-icon">${item.icon}</div>
              <div class="shop-item-info">
                <div class="shop-item-name">${item.name}</div>
                <div class="shop-item-desc">${item.desc}</div>
                <div class="shop-item-price">‰ª∑Ê†º: ${item.price} ÈáëÂ∏Å</div>
              </div>
              <button 
                class="shop-buy-btn" 
                data-item-id="${item.id}"
                ${!canAfford || alreadyOwned ? 'disabled' : ''}
              >
                ${alreadyOwned ? 'Â∑≤Êã•Êúâ' : (canAfford ? 'Ë¥≠‰π∞' : 'ÈáëÂ∏Å‰∏çË∂≥')}
              </button>
            </div>
          `;
        }).join('');
        
        // ÁªëÂÆöË¥≠‰π∞ÊåâÈíÆ‰∫ã‰ª∂
        document.querySelectorAll('.shop-buy-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const itemId = e.target.dataset.itemId;
            buyItem(itemId);
          });
        });
      }

      function buyItem(itemId) {
        const item = SHOP_ITEMS.find(i => i.id === itemId);
        if (!item || state.coins < item.price) {
          playSound('error');
          return;
        }
        
        state.coins -= item.price;
        state.ownedItems.push({...item});
        
        // Êí≠ÊîæË¥≠‰π∞Èü≥Êïà
        playSound('coin');
        
        // Â∫îÁî®ÈÅìÂÖ∑ÊïàÊûú
        applyItemEffect(item);
        
        ui.coins.textContent = state.coins;
        renderShop();
        
        ui.feedback.textContent = `üéâ ÊàêÂäüË¥≠‰π∞ ${item.name}ÔºÅ`;
        ui.feedback.className = 'feedback success';
      }

      function applyItemEffect(item) {
        switch (item.effect) {
          case 'gold_boost':
            state.activeEffects.goldMultiplier = 2;
            state.activeEffects.goldBoostUses = item.uses;
            break;
          case 'hint':
            state.activeEffects.hintAvailable = true;
            addHintButton();
            break;
          case 'exp_boost':
            state.activeEffects.expBoost = 0.8; // ÈúÄË¶Å80%ÁöÑÂÆùÁâ©Â∞±ËÉΩÂçáÁ∫ß
            break;
          case 'luck':
            state.activeEffects.luckUses = item.uses;
            break;
          case 'voice_boost':
            // ËØ≠Èü≥ËØÜÂà´Â¢ûÂº∫ÔºàÂú®ËØÜÂà´Êó∂Â§ÑÁêÜÔºâ
            state.activeEffects.voiceBoost = true;
            break;
        }
      }

      function addHintButton() {
        if (document.getElementById('hint-btn')) return;
        
        const hintBtn = document.createElement('button');
        hintBtn.id = 'hint-btn';
        hintBtn.className = 'treasure-btn';
        hintBtn.style.background = 'linear-gradient(145deg, var(--treasure-silver), #e8e8e8)';
        hintBtn.style.color = '#2d1b0a';
        hintBtn.style.marginBottom = '10px';
        hintBtn.textContent = 'üîÆ Ëé∑ÂèñÊèêÁ§∫';
        
        hintBtn.addEventListener('click', () => {
          if (state.activeEffects.hintAvailable && state.currentTreasure) {
            const hint = state.currentTreasure.name.charAt(0).toUpperCase() + '***';
            ui.feedback.textContent = `üí° ÊèêÁ§∫ÔºöÂçïËØç‰ª• "${hint}" ÂºÄÂ§¥`;
            ui.feedback.className = 'feedback';
            
            // Ê∂àËÄóÊèêÁ§∫Ê¨°Êï∞
            const hintItem = state.ownedItems.find(item => item.id === 'hint_crystal');
            if (hintItem) {
              hintItem.uses--;
              if (hintItem.uses <= 0) {
                state.ownedItems = state.ownedItems.filter(item => item.id !== 'hint_crystal');
                state.activeEffects.hintAvailable = false;
                hintBtn.remove();
              }
            }
          }
        });
        
        document.querySelector('.action-buttons').insertBefore(hintBtn, ui.speakBtn);
      }

      function openShop() {
        renderShop();
        ui.shopModal.style.display = 'flex';
      }

      function closeShop() {
        ui.shopModal.style.display = 'none';
      }

      // --- Unit System Functions ---
      function initializeUnitSystem() {
        // Initialize unit progress
        Object.keys(UNIT_TREASURES).forEach(unitId => {
          state.unitProgress[unitId] = {
            completed: 0,
            total: UNIT_TREASURES[unitId].words.length,
            masteredWords: new Set()
          };
        });
        
        renderUnitGrid();
        updateCurrentUnitDisplay();
      }

      function renderUnitGrid() {
        const units = Object.entries(UNIT_TREASURES).map(([unitId, unitData]) => {
          const progress = state.unitProgress[unitId];
          const completionRate = Math.round((progress.completed / progress.total) * 100);
          const isActive = state.selectedUnit === unitId;
          const isCompleted = progress.completed === progress.total;
          
          return `
            <div class="unit-card ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}" 
                 data-unit-id="${unitId}" 
                 title="${unitData.name}: ${progress.completed}/${progress.total} Â∑≤ÊéåÊè°">
              <span class="unit-icon">${unitData.icon}</span>
              <div class="unit-name">${unitData.name.split(' - ')[1]}</div>
              <div class="unit-progress">${isCompleted ? '‚úÖ' : completionRate + '%'}</div>
            </div>
          `;
        });
        
        ui.unitGrid.innerHTML = units.join('');
        
        // Add click listeners to unit cards
        document.querySelectorAll('.unit-card').forEach(card => {
          card.addEventListener('click', () => {
            const unitId = card.dataset.unitId;
            selectUnit(unitId);
            playSound('click');
          });
        });
      }

      function selectUnit(unitId) {
        state.selectedUnit = unitId;
        renderUnitGrid();
        updateCurrentUnitDisplay();
        loadNewTreasure(); // Load a new treasure from the selected unit
        
        // Collapse unit grid after selection
        state.unitGridExpanded = false;
        ui.unitGrid.classList.remove('expanded');
        ui.unitToggle.textContent = 'Â±ïÂºÄÂçïÂÖÉÈÄâÊã©';
        
        ui.feedback.textContent = `üéØ Â∑≤ÂàáÊç¢Âà∞ ${UNIT_TREASURES[unitId].name}ÔºÅÂáÜÂ§áÂºÄÂßãÂ≠¶‰π†ÂêßÔºÅ`;
        ui.feedback.className = 'feedback';
      }

      function resetUnitSelection() {
        state.selectedUnit = null;
        renderUnitGrid();
        updateCurrentUnitDisplay();
        loadNewTreasure();
        
        ui.feedback.textContent = 'üåü Â∑≤ÂàáÊç¢Âà∞ÂÖ®ÈÉ®ÂçïÂÖÉÊ∑∑ÂêàÊ®°ÂºèÔºÅ';
        ui.feedback.className = 'feedback';
      }

      function updateCurrentUnitDisplay() {
        if (state.selectedUnit) {
          const unitData = UNIT_TREASURES[state.selectedUnit];
          const progress = state.unitProgress[state.selectedUnit];
          const remaining = progress.total - progress.completed;
          
          if (progress.completed === progress.total) {
            ui.currentUnitInfo.textContent = `üéØ ÂΩìÂâçÔºö${unitData.name} ‚úÖ Â∑≤ÂÆåÊàêÔºÅ`;
          } else {
            ui.currentUnitInfo.textContent = `üéØ ÂΩìÂâçÔºö${unitData.name} (${progress.completed}/${progress.total}) ËøòÂâ©${remaining}‰∏™`;
          }
        } else {
          // Show overall progress in mixed mode
          let totalCompleted = 0;
          let totalWords = 0;
          Object.values(state.unitProgress).forEach(progress => {
            totalCompleted += progress.completed;
            totalWords += progress.total;
          });
          ui.currentUnitInfo.textContent = `üéØ ÂΩìÂâçÔºöÂÖ®ÈÉ®ÂçïÂÖÉÊ∑∑ÂêàÊ®°Âºè (${totalCompleted}/${totalWords})`;
        }
      }

      function toggleUnitGrid() {
        state.unitGridExpanded = !state.unitGridExpanded;
        if (state.unitGridExpanded) {
          ui.unitGrid.classList.add('expanded');
          ui.unitToggle.textContent = 'Êî∂Ëµ∑ÂçïÂÖÉÈÄâÊã©';
        } else {
          ui.unitGrid.classList.remove('expanded');
          ui.unitToggle.textContent = 'Â±ïÂºÄÂçïÂÖÉÈÄâÊã©';
        }
        playSound('click');
      }

      function getCurrentTreasureSource() {
        if (state.selectedUnit) {
          // Return only unmastered words from selected unit
          const unitData = UNIT_TREASURES[state.selectedUnit];
          const unitProgress = state.unitProgress[state.selectedUnit];
          
          // Filter out already mastered words
          const unmasteredWords = unitData.words.filter(word => 
            !unitProgress.masteredWords.has(word.name)
          );
          
          // If all words are mastered, congratulate and switch to mixed mode
          if (unmasteredWords.length === 0) {
            ui.feedback.textContent = `üéâ ÊÅ≠ÂñúÔºÅ‰Ω†Â∑≤ÂÆåÂÖ®ÊéåÊè°${unitData.name}ÁöÑÊâÄÊúâÂçïËØçÔºÅËá™Âä®ÂàáÊç¢Âà∞Ê∑∑ÂêàÊ®°ÂºèÁªßÁª≠ÊåëÊàòÔºÅ`;
            ui.feedback.className = 'feedback success';
            playSound('level');
            
            // Reset to mixed mode after 3 seconds
            setTimeout(() => {
              resetUnitSelection();
            }, 3000);
            
            // Return all words as fallback for now
            const allWords = [];
            Object.values(UNIT_TREASURES).forEach(unitData => {
              allWords.push(...unitData.words);
            });
            return allWords;
          }
          
          return unmasteredWords;
        } else {
          // Return all words from all units (mixed mode) - but prioritize unmastered ones
          const unmasteredWords = [];
          const masteredWords = [];
          
          Object.entries(UNIT_TREASURES).forEach(([unitId, unitData]) => {
            const unitProgress = state.unitProgress[unitId];
            unitData.words.forEach(word => {
              if (unitProgress.masteredWords.has(word.name)) {
                masteredWords.push(word);
              } else {
                unmasteredWords.push(word);
              }
            });
          });
          
          // Return unmastered words first, with some mastered words for review (20% chance)
          if (unmasteredWords.length > 0) {
            // 80% unmastered, 20% mastered for review
            if (Math.random() < 0.8 || masteredWords.length === 0) {
              return unmasteredWords;
            } else {
              return masteredWords;
            }
          } else {
            // All words mastered - return all for continued practice
            return masteredWords;
          }
        }
      }

      function markWordAsCompleted(wordName) {
        // Find which unit this word belongs to
        const unitId = findWordUnit(wordName);
        if (unitId && !state.unitProgress[unitId].masteredWords.has(wordName)) {
          state.unitProgress[unitId].masteredWords.add(wordName);
          state.unitProgress[unitId].completed++;
          
          // Update unit display if we're in that unit
          if (state.selectedUnit === unitId) {
            updateCurrentUnitDisplay();
          }
          
          renderUnitGrid();
        }
      }

      function findWordUnit(wordName) {
        for (const [unitId, unitData] of Object.entries(UNIT_TREASURES)) {
          if (unitData.words.some(word => word.name === wordName)) {
            return unitId;
          }
        }
        return null;
      }

      // --- Game Functions ---
      function loadNewTreasure() {
        // Use unit-based treasure source instead of difficulty levels
        const availableTreasures = getCurrentTreasureSource();
        
        // Safety check: if no treasures available, fallback to all words
        if (!availableTreasures || availableTreasures.length === 0) {
          console.warn('No available treasures, falling back to all words');
          const allWords = [];
          Object.values(UNIT_TREASURES).forEach(unitData => {
            allWords.push(...unitData.words);
          });
          const randomTreasure = allWords[Math.floor(Math.random() * allWords.length)];
          state.currentTreasure = randomTreasure;
        } else {
          const randomTreasure = availableTreasures[Math.floor(Math.random() * availableTreasures.length)];
          state.currentTreasure = randomTreasure;
        }
        
        ui.treasureName.textContent = state.currentTreasure.name;
        ui.treasurePhonetic.textContent = state.currentTreasure.ipa;
        ui.treasureDescription.textContent = state.currentTreasure.desc;
        ui.treasureValue.textContent = `‰ª∑ÂÄº: ${state.currentTreasure.value}ÈáëÂ∏Å`;
        ui.treasureChest.textContent = state.currentTreasure.icon;
        
        // Ê†πÊçÆÂÆùÁâ©Á≠âÁ∫ßÊîπÂèòÂÆùÁÆ±È¢úËâ≤
        const colors = {
          bronze: 'linear-gradient(145deg, #cd7f32, #8b4513)',
          silver: 'linear-gradient(145deg, #c0c0c0, #808080)',
          gold: 'linear-gradient(145deg, #ffd700, #b8860b)',
          diamond: 'linear-gradient(145deg, #b9f2ff, #87ceeb)'
        };
        ui.treasureChest.style.background = colors[level];
      }

      function checkTreasureName(inputText) {
        const targetName = state.currentTreasure.name;
        const userInput = inputText.trim().toLowerCase();
        
        if (userInput === targetName.toLowerCase()) {
          handleCorrectAnswer();
        } else {
          playSound('error');
          ui.feedback.textContent = `‚ùå ÂííËØ≠ÈîôËØØÔºÅ‰Ω†ËØ¥ÁöÑÊòØ "${inputText}"ÔºåÊ≠£Á°ÆÁöÑÂ∫îËØ•ÊòØ "${targetName}"`;
          ui.feedback.className = 'feedback error';
          
          // Auto-play correct pronunciation after 1 second
          setTimeout(() => {
            speakWord(targetName);
            ui.feedback.textContent = `üîä Ê≠£Âú®Êí≠ÊîæÊ≠£Á°ÆÂèëÈü≥Ôºö"${targetName}"`;
          }, 1000);
        }
      }

      // Text-to-Speech function for pronunciation demonstration
      function speakWord(word, isManual = false) {
        if ('speechSynthesis' in window) {
          // Cancel any ongoing speech
          speechSynthesis.cancel();
          
          // Disable pronunciation button temporarily
          if (ui.pronunciationBtn) {
            ui.pronunciationBtn.disabled = true;
            ui.pronunciationBtn.textContent = 'üîä Êí≠Êîæ‰∏≠...';
          }
          
          const utterance = new SpeechSynthesisUtterance(word);
          utterance.lang = 'en-US';
          utterance.rate = 0.8; // Slightly slower for clearer pronunciation
          utterance.pitch = 1;
          utterance.volume = 0.8;
          
          // Load voices if not already loaded
          let voices = speechSynthesis.getVoices();
          if (voices.length === 0) {
            // Wait for voices to load
            speechSynthesis.addEventListener('voiceschanged', () => {
              voices = speechSynthesis.getVoices();
            });
          }
          
          // Try to use a high-quality English voice
          const englishVoice = voices.find(voice => 
            voice.lang.startsWith('en') && (
              voice.name.includes('Google') || 
              voice.name.includes('Microsoft') ||
              voice.name.includes('Alex') ||
              voice.name.includes('Samantha') ||
              voice.name.includes('Daniel') ||
              voice.name.includes('Karen')
            )
          ) || voices.find(voice => voice.lang.startsWith('en'));
          
          if (englishVoice) {
            utterance.voice = englishVoice;
          }
          
          utterance.onend = () => {
            // Re-enable pronunciation button
            if (ui.pronunciationBtn) {
              ui.pronunciationBtn.disabled = false;
              ui.pronunciationBtn.textContent = 'üîä Âê¨ÂèëÈü≥';
            }
            
            if (isManual) {
              ui.feedback.textContent = `üéµ Â∑≤Êí≠Êîæ"${word}"ÁöÑÂèëÈü≥ÔºåÁé∞Âú®ËØïÁùÄËØ¥Âá∫Êù•ÂêßÔºÅ`;
              ui.feedback.className = 'feedback';
            } else {
              ui.feedback.textContent = `üí° Âê¨Ê∏ÖÊ•ö‰∫ÜÂêóÔºüÂÜçËØï‰∏ÄÊ¨°ËØ¥Âá∫Ôºö"${word}"`;
              ui.feedback.className = 'feedback';
            }
          };
          
          utterance.onerror = (event) => {
            console.warn('Speech synthesis error:', event.error);
            
            // Re-enable pronunciation button
            if (ui.pronunciationBtn) {
              ui.pronunciationBtn.disabled = false;
              ui.pronunciationBtn.textContent = 'üîä Âê¨ÂèëÈü≥';
            }
            
            ui.feedback.textContent = `üìñ ËØ≠Èü≥Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑ÁúãÈü≥Ê†áÔºö"${word}" ${state.currentTreasure.ipa}`;
            ui.feedback.className = 'feedback';
          };
          
          // Play the word
          speechSynthesis.speak(utterance);
        } else {
          // Fallback when speech synthesis is not available
          ui.feedback.textContent = `üìñ ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥Êí≠ÊîæÔºåËØ∑ÁúãÈü≥Ê†áÔºö${state.currentTreasure.ipa}`;
          ui.feedback.className = 'feedback';
        }
      }

      function handleCorrectAnswer() {
        const reward = state.currentTreasure.value;
        const bonusMultiplier = 1 + (state.level - 1) * 0.1;
        let finalReward = Math.floor(reward * bonusMultiplier);
        
        // Â∫îÁî®ÈªÑÈáëËçØÊ∞¥ÊïàÊûú
        if (state.activeEffects.goldBoostUses > 0) {
          finalReward *= state.activeEffects.goldMultiplier;
          state.activeEffects.goldBoostUses--;
          if (state.activeEffects.goldBoostUses <= 0) {
            state.activeEffects.goldMultiplier = 1;
          }
        }
        
        state.coins += finalReward;
        state.treasuresFound++;
        state.inventory.push(state.currentTreasure);
        
        // Mark word as completed in unit progress
        markWordAsCompleted(state.currentTreasure.name);
        
        // Êí≠ÊîæÊàêÂäüÈü≥ÊïàÂíåÈáëÂ∏ÅÈü≥Êïà
        playSound('success');
        setTimeout(() => playSound('coin'), 300);
        
        // Ê∑ªÂä†Â∫ÜÁ•ùÂä®Áîª
        ui.treasureChest.classList.add('celebrate');
        ui.coins.classList.add('coin-earned');
        
        ui.coins.textContent = state.coins;
        ui.treasures.textContent = state.treasuresFound;
        ui.feedback.textContent = `üéâ ÊÅ≠ÂñúÔºÅ‰Ω†Ëé∑Âæó‰∫Ü ${state.currentTreasure.name}ÔºÅ+${finalReward} ÈáëÂ∏Å`;
        ui.feedback.className = 'feedback success';
        
        // ÂçáÁ∫ßÊ£ÄÊü•ÔºàËÄÉËôëÁªèÈ™åÊä§Á¨¶ÊïàÊûúÔºâ
        const upgradeThreshold = Math.ceil(5 * state.activeEffects.expBoost);
        if (state.treasuresFound % upgradeThreshold === 0) {
          state.level++;
          ui.level.textContent = state.level;
          setTimeout(() => {
            playSound('level');
            ui.feedback.textContent = `‚≠ê ÊÅ≠ÂñúÂçáÁ∫ßÂà∞ ${state.level} Á∫ßÔºÅËß£ÈîÅÊõ¥ÁèçË¥µÁöÑÂÆùËóèÔºÅ`;
            ui.feedback.className = 'feedback success';
          }, 2000);
        }
        
        // Ê∏ÖÈô§Âä®ÁîªÁ±ª
        setTimeout(() => {
          ui.treasureChest.classList.remove('celebrate');
          ui.coins.classList.remove('coin-earned');
        }, 600);
        
        // 3ÁßíÂêéÂä†ËΩΩÊñ∞ÂÆùÁâ©
        setTimeout(() => {
          loadNewTreasure();
          ui.feedback.textContent = 'üîç ÂèëÁé∞Êñ∞ÁöÑÂÆùËóèÔºÅÂáÜÂ§áÂ•ΩËØ¥Âá∫ÂÆÉÁöÑÁúüÂêç‰∫ÜÂêóÔºü';
          ui.feedback.className = 'feedback';
        }, 3000);
      }

      // --- Event Listeners ---
      ui.speakBtn.addEventListener('click', () => {
        playSound('click');
        if (recognizer && !state.recognizing) {
          recognizer.start();
        }
      });

      ui.submitBtn.addEventListener('click', () => {
        playSound('click');
        const inputText = ui.manualInput.value;
        if (inputText.trim()) {
          checkTreasureName(inputText);
          ui.manualInput.value = '';
        }
      });
      
      ui.manualInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          ui.submitBtn.click();
        }
      });

      ui.shopBtn.addEventListener('click', () => {
        playSound('click');
        openShop();
      });
      
      ui.shopClose.addEventListener('click', () => {
        playSound('click');
        closeShop();
      });
      
      // ÁÇπÂáªÊ®°ÊÄÅÁ™óÂè£Â§ñÈÉ®ÂÖ≥Èó≠ÂïÜÂ∫ó
      ui.shopModal.addEventListener('click', (e) => {
        if (e.target === ui.shopModal) {
          closeShop();
        }
      });

      // Unit system event listeners
      ui.unitToggle.addEventListener('click', toggleUnitGrid);
      ui.resetUnitBtn.addEventListener('click', () => {
        playSound('click');
        resetUnitSelection();
      });

      // Pronunciation button event listener
      ui.pronunciationBtn.addEventListener('click', () => {
        playSound('click');
        if (state.currentTreasure) {
          speakWord(state.currentTreasure.name, true);
        }
      });

      // --- Initialize Game ---
      initializeTreasures(); // Initialize compatibility system
      initializeUnitSystem();
      loadNewTreasure();
    });
  </script>
</body>
</html>